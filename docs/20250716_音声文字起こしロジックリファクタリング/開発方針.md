# SpeechToTextPipeline å†è¨­è¨ˆæ–¹é‡æ›¸ï¼ˆ2025å¹´7# âœ… ç›®çš„

ç¾è¡Œã® SpeechToTextPipeline ã¯å‡¦ç†ãŒå¯†çµåˆã§ã€ä¿å®ˆæ€§ãƒ»å†å®Ÿè¡Œæ€§ãƒ»æ‹¡å¼µæ€§ã«èª²é¡ŒãŒã‚ã‚‹ã€‚ç‰¹ã«ã‚¹ãƒ†ãƒƒãƒ—8ã«è¤‡æ•°è²¬ä»»ãŒé›†ä¸­ã—ã¦ãŠã‚Šã€å¤‰æ›´è€æ€§ãŒä½ã„ã€‚ãã®ãŸã‚ã€ä»¥ä¸‹ã‚’ç›®çš„ã¨ã—ã¦æ§‹æˆã‚’å…¨é¢çš„ã«è¦‹ç›´ã™ï¼š

- **å„ã‚¹ãƒ†ãƒƒãƒ—å‡¦ç†ã®è²¬å‹™åˆ†é›¢ã¨ç°¡ç´ åŒ–**
- **Azure Queue Triggerãƒ™ãƒ¼ã‚¹ã§ã®éåŒæœŸãƒ»ä¸¦åˆ—å‡¦ç†åŒ–**
- **å„ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«æ˜ç¢ºåŒ–**
- **æœ€çµ‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¹ãƒ†ãƒƒãƒ—ï¼ˆStep8ï¼‰ã‚’å˜ç´”ã«ã™ã‚‹ãŸã‚ã®ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«å°å…¥**
- **ãƒ•ã‚£ãƒ©ãƒ¼è£œå®Œãƒ­ã‚¸ãƒƒã‚¯ã®æ¤œè¨¼æ€§å‘ä¸Šã®ãŸã‚ã€ã‚¹ã‚³ã‚¢è¨ˆç®—ã«ä½¿ã†æ–‡æ§‹é€ ã‚’è£œåŠ©ã‚«ãƒ©ãƒ ã«ä¿æŒ**

## âœ… å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—æ§‹æˆï¼ˆ4éšï¼‰

| ã‚¹ãƒ†ãƒƒãƒ—å | å‡¦ç†ç¯„å›² | ä¸»ãªå‡¦ç†å†…å®¹ | OpenAIä½¿ç”¨ | å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«å |
|------------|----------|--------------|------------|----------------|
| PreprocessingStep | Step1ã€œ3 | ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåŒ–ã€ãƒ•ã‚£ãƒ©ãƒ¼å€™è£œã‚¹ã‚³ã‚¢ä»˜ã‘ã€è£œå®Œå€™è£œæŒ¿å…¥ | âœ…ï¼ˆStep2ï¼‰ | TranscriptProcessingSegments |
| MergingAndCleanupStep | Step4ã€œ6 | ã‚»ã‚°ãƒ¡ãƒ³ãƒˆçµ±åˆã€è©±è€…æ•´å½¢ã€OpenAIã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ©ãƒ¼é™¤å» | âœ…ï¼ˆStep6ï¼‰ | ProcessedTranscriptSegments |
| SummarizationStep | Step7 | ãƒ–ãƒ­ãƒƒã‚¯è¦ç´„ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆã¨æ•´å½¢æ¸ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ä¿æŒ | âœ… | ConversationSummaries |
| ExportStep | Step8 | ConversationSummaries ã‹ã‚‰ ConversationSegments ã¸å‡ºåŠ› | âŒ | ConversationSegments |

## ğŸ—‚ ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ä¸€è¦§

### 1. TranscriptProcessingSegmentsï¼ˆPreprocessingStepï¼‰

```sql
CREATE TABLE TranscriptProcessingSegments (
    id INT IDENTITY(1,1) PRIMARY KEY,
    meeting_id INT NOT NULL,
    line_no INT NOT NULL,
    speaker INT NOT NULL,
    transcript_text_segment NVARCHAR(MAX) NOT NULL,
    offset_seconds FLOAT NULL,
    is_filler BIT NOT NULL DEFAULT 0,
    front_score FLOAT NULL,
    after_score FLOAT NULL,
    merged_text_with_prev NVARCHAR(MAX) NULL,  -- ãƒ•ã‚£ãƒ©ãƒ¼åˆ¤å®šå‰ï¼šå‰æ–‡ã¨ã®çµåˆ
    merged_text_with_next NVARCHAR(MAX) NULL,  -- ãƒ•ã‚£ãƒ©ãƒ¼åˆ¤å®šå¾Œï¼šæ¬¡æ–‡ã¨ã®çµåˆ
    delete_candidate_word NVARCHAR(MAX) NULL,
    inserted_datetime DATETIME DEFAULT GETDATE(),
    updated_datetime DATETIME DEFAULT GETDATE()
)
```

â€» `merged_text_with_prev` ãŠã‚ˆã³ `merged_text_with_next` ã¯ã€`is_filler = 1` ã®è¡Œã§ã‚¹ã‚³ã‚¢ä»˜ã‘ã«ä½¿ã‚ã‚ŒãŸå‰å¾Œæ–‡æ§‹æˆã‚’æ ¼ç´ã€‚

### 2. ProcessedTranscriptSegmentsï¼ˆMergingAndCleanupStepï¼‰

```sql
CREATE TABLE ProcessedTranscriptSegments (
    id INT IDENTITY(1) PRIMARY KEY,
    meeting_id INT NOT NULL,
    line_no INT NOT NULL,
    speaker INT NOT NULL,
    merged_text NVARCHAR(MAX) NOT NULL,
    cleaned_text NVARCHAR(MAX) NULL,
    offset_seconds FLOAT NULL,
    inserted_datetime DATETIME DEFAULT GETDATE(),
    updated_datetime DATETIME DEFAULT GETDATE()
)
```

### 3. ConversationSummariesï¼ˆSummarizationStepï¼‰

```sql
CREATE TABLE ConversationSummaries (
    id INT IDENTITY(1) PRIMARY KEY,
    meeting_id INT NOT NULL,
    speaker INT NOT NULL,
    content NVARCHAR(MAX) NOT NULL,
    offset_seconds FLOAT NULL,
    is_summary BIT NOT NULL DEFAULT 0,
    inserted_datetime DATETIME DEFAULT GETDATE(),
    updated_datetime DATETIME DEFAULT GETDATE()
)
```

### 4nversationSegmentsï¼ˆExportStepï¼‰

```sql
-- æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ« ConversationSegments ã‚’ç¶™ç¶šåˆ©ç”¨
-- ä¼šè©±ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆç®¡ç†ã®ãŸã‚ã®æœ€çµ‚æˆæœãƒ†ãƒ¼ãƒ–ãƒ«
```

## ğŸ” å®Ÿè¡Œæ§‹æˆï¼ˆQueue Triggerï¼‰

| Queueåä¾‹ | å¯¾å¿œFunctionå | å‡¦ç†å¯¾è±¡ |
|-----------|----------------|----------|
| queue-preprocessing | QueuePreprocessingFunc | status =transcribed' ã®ä¼šè­°ãªã© |
| queue-merging | QueueMergingFunc | Preprocessingå®Œäº†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ |
| queue-summary | QueueSummarizationFunc | æ•´å½¢æ¸ˆã¿ç™ºè©±ãƒ‡ãƒ¼ã‚¿ |
| queue-export | QueueExportFunc | ã‚µãƒãƒªä»˜ãç™ºè©±ãƒ‡ãƒ¼ã‚¿ |

## ğŸ“Œ å®Ÿè£…ä¸Šã®ãƒã‚¤ãƒ³ãƒˆ

- **å„Queueã«ã¯** `[object Object] meeting_id: 91` ã®ã‚ˆã†ãªJSONã§æ¸¡ã™
- **å„ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†æ™‚ã€æ¬¡ã®Queueã¸** `send_message()` ã‚’å®Ÿè¡Œ
- **Meetings.status ã‚’ã‚¹ãƒ†ãƒƒãƒ—åã«å¿œã˜ã¦æ›´æ–°**ï¼ˆä¾‹: `step3_completed` â†’ `step4_in_progress`ï¼‰

## âœ… ä»Šå¾Œã®å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

1. **å„å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ã® CREATE TABLE ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ•´å‚™**
2. **ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®Functionã‚’ QueueTrigger ã¨ã—ã¦æ–°è¦ä½œæˆ**
3. **Pollingã‹ã‚‰ã®Queueé€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ•´ç†**ï¼ˆstatus=transcribed â†’ queue-preprocessing ã¸ï¼‰
4. **å…¨ã‚¹ãƒ†ãƒƒãƒ—ã® status ç®¡ç†ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒãƒªã‚·ãƒ¼ã‚’è¨­è¨ˆ** 