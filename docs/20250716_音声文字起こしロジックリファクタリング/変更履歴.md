# SpeechToTextPipeline ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¤‰æ›´å±¥æ­´

## 2025å¹´7æœˆ16æ—¥ - QueuePreprocessingFunc ãƒ•ã‚£ãƒ©ãƒ¼åˆ¤å®šè£œåŠ©ã‚«ãƒ©ãƒ è¿½åŠ 

### ğŸ¯ å¤‰æ›´ç›®çš„
ãƒ•ã‚£ãƒ©ãƒ¼å€™è£œï¼ˆis_filler=1ï¼‰ã®å‰å¾Œæ–‡æ§‹é€ ã‚’æ˜ç¤ºçš„ã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚³ã‚¢åˆ¤å®šã®æ¤œè¨¼ã‚„æ”¹å–„ã®æ‰‹ãŒã‹ã‚Šã¨ã™ã‚‹ã€‚

### ğŸ“ å¤‰æ›´å†…å®¹

#### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `SpeechToTextPipeline/function_app.py`

#### å¯¾è±¡é–¢æ•°
- `QueuePreprocessingFunc`

#### è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯
**ã‚¹ãƒ†ãƒƒãƒ—2ï¼ˆãƒ•ã‚£ãƒ©ãƒ¼ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼‰éƒ¨åˆ†ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š**

**1. merged_text_with_prev ã®æ§‹ç¯‰**
   - `line_no - 1`ã® `transcript_text_segment` ã®æœ«å°¾ã‹ã‚‰ã€Œã€‚ã§åŒºåˆ‡ã‚‰ã‚ŒãŸæœ€å¾Œã®æ–‡ã€ã‚’å–å¾—
   - ãã®æœ«å°¾æ–‡ã¨ç¾åœ¨ã®ãƒ•ã‚£ãƒ©ãƒ¼æ–‡ï¼ˆline_noï¼‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
   - ä¾‹ï¼š
     ```
     N-1: ã“ã‚“ã«ã¡ã¯ã€‚è‰¯ã„å¤©æ°—ã€‚
     N  : ãˆã£ã¨ã€‚
     â†’ merged_text_with_prev: è‰¯ã„å¤©æ°—ãˆã£ã¨ã€‚
     ```

**2. merged_text_with_next ã®æ§‹ç¯‰**
   - `line_no + 1`ã® `transcript_text_segment` ã®å…ˆé ­æ–‡ã‚’å–å¾—
   - ç¾åœ¨ã®ãƒ•ã‚£ãƒ©ãƒ¼æ–‡ã®æœ«å°¾ã®ã€Œã€‚ã€ã‚’é™¤ãã€æ¬¡ã®æ–‡ã¨çµåˆ
   - ä¾‹ï¼š
     ```
     N  : ãˆã£ã¨ã€‚
     N+1: æ˜æ—¥ã¯é›¨ã§ã™ã€‚
     â†’ merged_text_with_next: ãˆã£ã¨æ˜æ—¥ã¯é›¨ã§ã™ã€‚
     ```

#### å®Ÿè£…ã‚³ãƒ¼ãƒ‰
```python
# ãƒ•ã‚£ãƒ©ãƒ¼åˆ¤å®šè£œåŠ©ã‚«ãƒ©ãƒ ã®æ§‹ç¯‰
merged_text_with_prev = ""
merged_text_with_next = ""

# merged_text_with_prev: å‰ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æœ€å¾Œã®æ–‡ + ç¾åœ¨ã®æ–‡
if prev_text:
    prev_sentences = [s.strip() for s in prev_text.strip().split("ã€‚") if s.strip()]
    prev_last_sentence = prev_sentences[-1] if prev_sentences else ""
    merged_text_with_prev = prev_last_sentence + bracket_text

# merged_text_with_next: ç¾åœ¨ã®æ–‡ï¼ˆã€‚ã‚’é™¤ãï¼‰+ æ¬¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æœ€åˆã®æ–‡
if next_text:
    next_sentences = [s.strip() for s in next_text.strip().split("ã€‚") if s.strip()]
    next_first_sentence = next_sentences[0] if next_sentences else ""
    merged_text_with_next = bracket_text.strip("ã€‚") + next_first_sentence

# DBæ›´æ–°ï¼ˆè£œåŠ©ã‚«ãƒ©ãƒ ã‚‚å«ã‚ã¦ï¼‰
cursor.execute("""
    UPDATE dbo.TranscriptProcessingSegments
    SET front_score = ?, after_score = ?, 
        merged_text_with_prev = ?, merged_text_with_next = ?,
        updated_datetime = GETDATE()
    WHERE meeting_id = ? AND line_no = ?
""", (front_score, back_score, merged_text_with_prev, merged_text_with_next, meeting_id, line_no))
```

### ğŸ—‚ å½±éŸ¿ãƒ†ãƒ¼ãƒ–ãƒ«
- `TranscriptProcessingSegments`
  - `merged_text_with_prev` (æ–°è¦è¿½åŠ )
  - `merged_text_with_next` (æ–°è¦è¿½åŠ )

### âœ… æœŸå¾…åŠ¹æœ
1. **æ¤œè¨¼æ€§å‘ä¸Š**: ã‚¹ã‚³ã‚¢è¨ˆç®—ã«ä½¿ç”¨ã•ã‚ŒãŸå‰å¾Œæ–‡æ§‹é€ ãŒæ˜ç¤ºçš„ã«ä¿å­˜ã•ã‚Œã‚‹
2. **ãƒ‡ãƒãƒƒã‚°æ”¯æ´**: ãƒ•ã‚£ãƒ©ãƒ¼åˆ¤å®šã®æ ¹æ‹ ã‚’å¾Œã‹ã‚‰ç¢ºèªå¯èƒ½
3. **æ”¹å–„åŸºç›¤**: ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„æ™‚ã«å‚è€ƒãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ´»ç”¨

### ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã®æ›´æ–°ï¼ˆ`merged_text_with_prev`, `merged_text_with_next` ã‚«ãƒ©ãƒ è¿½åŠ ï¼‰
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
- è£œåŠ©ã‚«ãƒ©ãƒ ã‚’æ´»ç”¨ã—ãŸæ¤œè¨¼ãƒ»åˆ†ææ©Ÿèƒ½ã®å®Ÿè£…

## 2025å¹´7æœˆ22æ—¥ - QueueMergingAndCleanupFunc ä¸å…·åˆä¿®æ­£

### ğŸ¯ ä¿®æ­£ç›®çš„
ProcessedTranscriptSegments.merged_text ã«ä¸è‡ªç„¶ãªç™ºè©±ï¼ˆä¾‹ï¼šã€Œå¤§ä¸ˆã€‚ï¼ˆå¤«ã§ã™ã€‚ï¼‰ï¼ˆå¤§ä¸ˆå¤«ã§ã™ã€‚ï¼‰ã€ï¼‰ãŒå«ã¾ã‚Œã‚‹å•é¡Œã‚’è§£æ±ºã€‚

### ğŸ” å•é¡Œã®ç‰¹å®š

#### å•é¡Œâ‘ : delete_candidate_word ãŒé©åˆ‡ã«å‰Šé™¤ã•ã‚Œãªã„
- **ç¾è±¡**: `delete_candidate_word = "å¤§ä¸ˆã€‚"` ãŒè£œå®Œå…ƒãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã•ã‚Œãšã€è£œå®Œå¾Œã®æ–‡ã¨å…±å­˜
- **åŸå› **: `replace()` å‡¦ç†ãŒå¥ç‚¹ã‚„ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ã¦ã„ãªã„
- **å½±éŸ¿**: ã€Œå¤§ä¸ˆã€‚ã€ã¨ã€Œå¤§ä¸ˆå¤«ã§ã™ã€‚ã€ãŒä¸¡æ–¹æ®‹ã‚Šã€ä¸è‡ªç„¶ãªç™ºè©±ã«ãªã‚‹

#### å•é¡Œâ‘¡: is_filler=True ã®è¡ŒãŒçµ±åˆå¯¾è±¡ã«å«ã¾ã‚Œã‚‹
- **ç¾è±¡**: ãƒ•ã‚£ãƒ©ãƒ¼è¡Œï¼ˆä¾‹ï¼šã€Œï¼ˆå¤«ã§ã™ã€‚ï¼‰ã€ï¼‰ãŒ `pre_merged_text_segments` ã«å«ã¾ã‚Œã¦ãƒãƒ¼ã‚¸å¯¾è±¡ã«ãªã‚‹
- **åŸå› **: ãƒ•ã‚£ãƒ©ãƒ¼è¡Œã®é™¤å¤–å‡¦ç†ãŒä¸å®Œå…¨
- **å½±éŸ¿**: æœ¬æ¥é™¤å¤–ã•ã‚Œã‚‹ã¹ããƒ•ã‚£ãƒ©ãƒ¼è¡ŒãŒæœ€çµ‚å‡ºåŠ›ã«å«ã¾ã‚Œã‚‹

### ğŸ› ï¸ ä¿®æ­£å†…å®¹

#### 1. delete_candidate_word å‰Šé™¤å‡¦ç†ã®å¼·åŒ–
```python
# ä¿®æ­£å‰
cleaned_prev_text = prev_transcript_text.replace(prev_delete_candidate_word, "")

# ä¿®æ­£å¾Œ
import re
delete_pattern = re.escape(prev_delete_candidate_word.strip())
cleaned_prev_text = re.sub(f"{delete_pattern}[ã€‚]?\\s*", "", prev_transcript_text)
```

- **æ”¹å–„ç‚¹**: å¥ç‚¹ä»˜ãã€ã‚¹ãƒšãƒ¼ã‚¹ä»˜ãã€å¥ç‚¹ã®ã¿ãªã©æ§˜ã€…ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œ
- **å¯¾å¿œãƒ‘ã‚¿ãƒ¼ãƒ³**: ã€Œå¤§ä¸ˆã€‚ã€ã€Œå¤§ä¸ˆ ã€ã€Œå¤§ä¸ˆã€ãªã©

#### 2. ãƒ•ã‚£ãƒ©ãƒ¼è¡Œé™¤å¤–å‡¦ç†ã®å¼·åŒ–
```python
# è£œå®Œå‡¦ç†å¾Œã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
if is_filler:
    logging.info(f"[STEP4] Skipping filler line {line_no} after processing")
    continue
```

- **æ”¹å–„ç‚¹**: ãƒ•ã‚£ãƒ©ãƒ¼è¡Œã¯è£œå®Œå‡¦ç†å¾Œã‚‚ç¢ºå®Ÿã«é™¤å¤–
- **åŠ¹æœ**: ãƒ•ã‚£ãƒ©ãƒ¼è¡ŒãŒ `pre_merged_text_segments` ã«å«ã¾ã‚Œã‚‹ã“ã¨ã‚’é˜²æ­¢

### âœ… æœŸå¾…åŠ¹æœ
1. **è‡ªç„¶ãªç™ºè©±ç”Ÿæˆ**: delete_candidate_word ãŒé©åˆ‡ã«å‰Šé™¤ã•ã‚Œã€è£œå®Œå¾Œã®æ–‡ã®ã¿ãŒæ®‹ã‚‹
2. **ãƒ•ã‚£ãƒ©ãƒ¼è¡Œé™¤å¤–**: ãƒ•ã‚£ãƒ©ãƒ¼è¡ŒãŒæœ€çµ‚å‡ºåŠ›ã«å«ã¾ã‚Œã‚‹ã“ã¨ãŒãªããªã‚‹
3. **å‡¦ç†ç²¾åº¦å‘ä¸Š**: å¥ç‚¹ã‚„ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ãŸæŸ”è»Ÿãªå‰Šé™¤å‡¦ç†

### ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- ä¿®æ­£å¾Œã®å‡ºåŠ›å“è³ªã®æ¤œè¨¼
- ä»–ã®ãƒ•ã‚£ãƒ©ãƒ¼è£œå®Œãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®å‹•ä½œç¢ºèª
- å¿…è¦ã«å¿œã˜ã¦æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª¿æ•´

## 2025å¹´7æœˆ16æ—¥ - TranscriptProcessingSegments ãƒ•ã‚£ãƒ©ãƒ¼è£œåŠ©ã‚«ãƒ©ãƒ ï¼ˆmerged_text_with_prev/nextï¼‰ç©ºå€¤å•é¡Œã®èª¿æŸ»ãƒ»ä¿®æ­£

### ğŸ¯ èƒŒæ™¯
TranscriptProcessingSegments ã® is_filler=1 ã®è¡Œã§ã€merged_text_with_prev / merged_text_with_next ãŒNULLã¨ãªã‚‹ã‚±ãƒ¼ã‚¹ãŒç™ºç”Ÿã€‚

### ğŸ” åŸå› èª¿æŸ»
- å‰å¾Œã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã‚„ã€split("ã€‚")ã®çµæœãŒç©ºãƒªã‚¹ãƒˆã¨ãªã‚‹å ´åˆã€çµåˆå€¤ãŒç©ºã®ã¾ã¾DBã«ä¿å­˜ã•ã‚Œã¦ã„ãŸã€‚
- å…ˆé ­ãƒ»æœ«å°¾è¡Œã‚„ã€Œã€‚ã€ãŒå«ã¾ã‚Œãªã„ç™ºè©±ãªã©ã€æ–‡åˆ†å‰²ã®å¢ƒç•Œã‚±ãƒ¼ã‚¹ã§ç©ºå€¤ã¨ãªã‚‹ã“ã¨ãŒå¤šã‹ã£ãŸã€‚

### ğŸ› ï¸ ä¿®æ­£å†…å®¹
- å‰å¾Œæ–‡ãŒç©ºã‚„ä¸æ­£ãªå ´åˆã‚‚ã€å¿…ãš ""ï¼ˆç©ºæ–‡å­—ï¼‰ã‚’æ ¼ç´ã™ã‚‹ã‚ˆã†æ˜ç¤ºçš„ã«ä¿®æ­£ã€‚
- å„æ®µéšã§è©³ç´°ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆå‰å¾Œæ–‡ãƒ»åˆ†å‰²æ–‡ãƒ»æœ€çµ‚çµåˆå€¤ï¼‰ã‚’å‡ºåŠ›ã—ã€åŸå› ç‰¹å®šãƒ»æ¤œè¨¼ã‚’å®¹æ˜“ã«ã—ãŸã€‚
- ãƒ­ã‚¸ãƒƒã‚¯ä¾‹ï¼š

```python
# merged_text_with_prev: å‰ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æœ€å¾Œã®æ–‡ + ç¾åœ¨ã®æ–‡
if prev_text and prev_text.strip():
    prev_sentences = [s.strip() for s in prev_text.strip().split("ã€‚") if s.strip()]
    if prev_sentences:
        prev_last_sentence = prev_sentences[-1]
        merged_text_with_prev = prev_last_sentence + bracket_text
    else:
        merged_text_with_prev = ""
else:
    merged_text_with_prev = ""

# merged_text_with_next: ç¾åœ¨ã®æ–‡ï¼ˆã€‚ã‚’é™¤ãï¼‰+ æ¬¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æœ€åˆã®æ–‡
if next_text and next_text.strip():
    next_sentences = [s.strip() for s in next_text.strip().split("ã€‚") if s.strip()]
    if next_sentences:
        next_first_sentence = next_sentences[0]
        merged_text_with_next = bracket_text.strip("ã€‚") + next_first_sentence
    else:
        merged_text_with_next = ""
else:
    merged_text_with_next = ""
```

- ãƒ­ã‚°ä¾‹ï¼š
  - å‰å¾Œæ–‡ãƒ»åˆ†å‰²æ–‡ãƒ»çµåˆçµæœãƒ»DBæ›´æ–°å†…å®¹ã‚’INFO/WARNINGã§å‡ºåŠ›

### âœ… çµæœ
- is_filler=True ã®å…¨è¡Œã§ merged_text_with_prev / merged_text_with_next ã«å¿…ãšå€¤ï¼ˆç©ºæ–‡å­—å«ã‚€ï¼‰ãŒæ ¼ç´ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ
- ãƒ­ã‚°ã§åŸå› ç‰¹å®šãƒ»ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãŒå®¹æ˜“ã«ãªã£ãŸ

### ğŸ“ å‚è€ƒ
- å…ˆé ­ãƒ»æœ«å°¾è¡Œã‚„ã€Œã€‚ã€ãŒå«ã¾ã‚Œãªã„ç™ºè©±ã‚‚å®‰å…¨ã«å‡¦ç†ã•ã‚Œã‚‹
- ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ»è£œå®Œç²¾åº¦æ”¹å–„ã®åŸºç›¤ã¨ã—ã¦æ´»ç”¨å¯èƒ½

## 2025å¹´7æœˆ16æ—¥ - ã‚¹ã‚³ã‚¢åˆ¤å®šå¯¾è±¡ã‚’ merged_text_with_prev / merged_text_with_next ã«çµ±ä¸€

### ğŸ¯ èƒŒæ™¯ãƒ»ç›®çš„
front_score / after_score ã®ã‚¹ã‚³ã‚¢åˆ¤å®šã«ä½¿ç”¨ã™ã‚‹æ–‡ãŒæ›–æ˜§ã§ã€merged_text_with_prev / merged_text_with_next ã¨ã®æ•´åˆæ€§ãŒå–ã‚Œã¦ã„ãªã‹ã£ãŸã€‚ã“ã‚Œã‚’è§£æ¶ˆã—ã€ã€Œæ–‡è„ˆçµåˆå¾Œã®æ–‡ã€ã‚’è©•ä¾¡ã™ã‚‹æ˜ç¢ºãªæ–¹é‡ã«çµ±ä¸€ã€‚

### ğŸ› ï¸ å¤‰æ›´å†…å®¹
- ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«ä¿®æ­£ï¼š
  - front_scoreï¼šmerged_text_with_prev ã‚’ã‚¹ã‚³ã‚¢å¯¾è±¡
  - back_score ï¼šmerged_text_with_next ã‚’ã‚¹ã‚³ã‚¢å¯¾è±¡
  - ã©ã¡ã‚‰ã‹ãŒç©ºã®å ´åˆã¯ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚’ã‚¹ã‚­ãƒƒãƒ—
- ãƒ­ã‚°ã‚‚è©³ç´°ã«å‡ºåŠ›

```python
# merged_text_with_prev/nextã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚³ã‚¢åˆ¤å®š
front_score = 0.0
back_score = 0.0
if merged_text_with_prev and merged_text_with_prev.strip():
    try:
        front_score_result = evaluate_connection_naturalness_no_period("", "", merged_text_with_prev)
        front_score = front_score_result.get("front_score", 0.0)
    except Exception as e:
        front_score = 0.0
if merged_text_with_next and merged_text_with_next.strip():
    try:
        back_score_result = evaluate_connection_naturalness_no_period("", "", merged_text_with_next)
        back_score = back_score_result.get("back_score", 0.0)
    except Exception as e:
        back_score = 0.0
```

### âœ… æœŸå¾…åŠ¹æœ
- æ–‡è„ˆã®æ•´åˆæ€§ã¨è£œå®Œçµæœã®èª¬æ˜æ€§ãŒå‘ä¸Š
- ã‚¹ã‚³ã‚¢è¨ˆç®—ã®æ ¹æ‹ ãŒæ˜ç¢ºåŒ–ã—ã€åˆ†æãƒ»æ”¹å–„ãŒå®¹æ˜“ã«

## 2025å¹´7æœˆ16æ—¥ - ãƒ•ã‚£ãƒ©ãƒ¼å‰Šé™¤åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®æ•´åˆæ€§ä¿®æ­£

### ğŸ¯ èƒŒæ™¯ãƒ»å•é¡Œ
TranscriptProcessingSegments ã® is_filler = True ã®è¡Œã§ã€ã‚¹ã‚³ã‚¢ã¨å‡ºåŠ›çµæœã«çŸ›ç›¾ãŒç™ºç”Ÿï¼š
- front_score = 0.4ï¼ˆä½ã„ = ä¸è‡ªç„¶ï¼‰
- after_score = 0.6ï¼ˆé«˜ã„ = è‡ªç„¶ï¼‰
- ã«ã‚‚ã‹ã‹ã‚ã‚‰ãš revised_text_segment ã¯ã€Œå¾Œæ¥ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã«åŸºã¥ã„ãŸå†…å®¹
- **ã€Œä¸è‡ªç„¶ãªæ–¹ãŒæ¡ç”¨ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã€**ã¨ã„ã†é€†è»¢ãŒèµ·ãã¦ã„ãŸ

### ğŸ” ç™ºè¦‹ã—ãŸå•é¡Œç‚¹

**ãƒ‘ã‚¿ãƒ¼ãƒ³â‘ ï¼ˆã‚¹ã‚³ã‚¢åˆ¤å®šã®é€†è»¢ï¼‰:**
- å…ƒã®ã‚³ãƒ¼ãƒ‰: `if front_score >= after_score:` 
- å•é¡Œ: ã‚¹ã‚³ã‚¢ãŒé«˜ã„æ–¹ï¼ˆè‡ªç„¶ãªæ–¹ï¼‰ã‚’é¸æŠã—ã¦ã„ãŸ
- ä¿®æ­£: `if front_score <= after_score:` ã«å¤‰æ›´ã—ã€ã‚¹ã‚³ã‚¢ãŒä½ã„æ–¹ï¼ˆä¸è‡ªç„¶ãªæ–¹ï¼‰ã‚’å‰Šé™¤å¯¾è±¡ã¨ã™ã‚‹

**ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¡ï¼ˆmerged_textã®æ´»ç”¨ï¼‰:**
- å…ƒã®ã‚³ãƒ¼ãƒ‰: å‰å¾Œã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å†å–å¾—ã—ã¦æ–‡ã‚’å†æ§‹ç¯‰
- ä¿®æ­£: æ—¢ã«ç”Ÿæˆæ¸ˆã¿ã® `merged_text_with_prev/next` ã‚’ç›´æ¥ä½¿ç”¨

### ğŸ› ï¸ ä¿®æ­£å†…å®¹

**1. ã‚¹ã‚³ã‚¢åˆ¤å®šã®ä¿®æ­£**: `front_score <= after_score` ã§åˆ¤å®šï¼ˆã‚¹ã‚³ã‚¢ãŒä½ã„æ–¹ã‚’å‰Šé™¤ï¼‰
**2. merged_textã®æ´»ç”¨**: æ—¢å­˜ã® `merged_text_with_prev/next` ã‚’ç›´æ¥ä½¿ç”¨
**3. è©³ç´°ãƒ­ã‚°ã®è¿½åŠ **: åˆ¤å®šéç¨‹ã¨çµæœã‚’è©³ç´°ã«å‡ºåŠ›

```python
# ã‚¹ã‚³ã‚¢ãŒä½ã„æ–¹ï¼ˆä¸è‡ªç„¶ãªæ–¹ï¼‰ã‚’å‰Šé™¤å¯¾è±¡ã¨ã™ã‚‹
if front_score <= after_score:
    # front_scoreãŒä½ã„ï¼ˆä¸è‡ªç„¶ï¼‰â†’ merged_text_with_prevã‚’ä½¿ã†
    revised_text = merged_text_with_prev
else:
    # after_scoreãŒä½ã„ï¼ˆä¸è‡ªç„¶ï¼‰â†’ merged_text_with_nextã‚’ä½¿ã†
    revised_text = merged_text_with_next
```

### âœ… çµæœ
- ã‚¹ã‚³ã‚¢ã¨å‰Šé™¤åˆ¤å®šãƒ»è£œå®Œç”Ÿæˆçµæœã®æ•´åˆæ€§ãŒå–ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ
- ä¸è‡ªç„¶ãªæ–‡è„ˆã‚’å‰Šé™¤ã—ã€è‡ªç„¶ãªæ–‡è„ˆã‚’ä¿æŒã™ã‚‹æ­£ã—ã„åˆ¤å®šãŒå¯èƒ½ã«

## 2025å¹´1æœˆ27æ—¥ - Queue Trigger ãƒ™ãƒ¼ã‚¹ã®éåŒæœŸå‡¦ç†é–¢æ•°ç¾¤å®Ÿè£…

### å®Ÿè£…å†…å®¹
- **PollingTranscriptionResultsé–¢æ•°ã¯ç·¨é›†ã›ãš**ã€æ–°ã—ã„Queue Triggerãƒ™ãƒ¼ã‚¹ã®é–¢æ•°ç¾¤ã‚’è¿½åŠ 
- 4ã¤ã®Queue Triggeré–¢æ•°ã‚’å®Ÿè£…ï¼š
  - `QueuePreprocessingFunc` (queue-preprocessing)
  - `QueueMergingAndCleanupFunc` (queue-merging)  
  - `QueueSummarizationFunc` (queue-summary)
  - `QueueExportFunc` (queue-export)

### å„é–¢æ•°ã®è²¬å‹™
1. **QueuePreprocessingFunc**
   - ã‚¹ãƒ†ãƒƒãƒ—1-3: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåŒ–ã€ãƒ•ã‚£ãƒ©ãƒ¼ã‚¹ã‚³ã‚¢ã€è£œå®Œå€™è£œ
   - å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«: `TranscriptProcessingSegments`
   - OpenAI APIä½¿ç”¨: âœ… (Step2)

2. **QueueMergingAndCleanupFunc**
   - ã‚¹ãƒ†ãƒƒãƒ—4-6: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆçµ±åˆã€è©±è€…æ•´å½¢ã€OpenAIãƒ•ã‚£ãƒ©ãƒ¼é™¤å»
   - å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«: `ProcessedTranscriptSegments`
   - OpenAI APIä½¿ç”¨: âœ… (Step6)

3. **QueueSummarizationFunc**
   - ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ–ãƒ­ãƒƒã‚¯è¦ç´„ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
   - å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«: `ConversationSummaries`
   - OpenAI APIä½¿ç”¨: âœ…

4. **QueueExportFunc**
   - ã‚¹ãƒ†ãƒƒãƒ—8: ConversationSummaries â†’ ConversationSegments
   - å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«: `ConversationSegments`
   - OpenAI APIä½¿ç”¨: âŒ

### ãƒ•ã‚£ãƒ©ãƒ¼åˆ¤å®šè£œåŠ©ã‚«ãƒ©ãƒ è¿½åŠ 
- `merged_text_with_prev`: å‰æ–‡ã¨ã®çµåˆãƒ†ã‚­ã‚¹ãƒˆ
- `merged_text_with_next`: æ¬¡æ–‡ã¨ã®çµåˆãƒ†ã‚­ã‚¹ãƒˆ
- ã“ã‚Œã‚‰ã®ã‚«ãƒ©ãƒ ã‚’ä½¿ã£ã¦OpenAI APIï¼ˆgpt-3.5-turboï¼‰ã§è‡ªç„¶ã•ã‚¹ã‚³ã‚¢ã‚’ç›´æ¥è©•ä¾¡
- `front_score`ã¨`after_score`ã‚’ç”Ÿæˆãƒ»ä¿å­˜

### ãƒ•ã‚£ãƒ©ãƒ¼å‰Šé™¤åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
- **ä¿®æ­£å‰**: ã‚¹ã‚³ã‚¢ãŒé«˜ã„æ–¹ã‚’å‰Šé™¤å¯¾è±¡ã«ã—ã¦ã„ãŸï¼ˆä¸æ•´åˆï¼‰
- **ä¿®æ­£å¾Œ**: ã‚¹ã‚³ã‚¢ãŒä½ã„æ–¹ï¼ˆä¸è‡ªç„¶ãªæ–¹ï¼‰ã‚’å‰Šé™¤å¯¾è±¡ã¨ã™ã‚‹
- `merged_text_with_prev`ã¾ãŸã¯`merged_text_with_next`ã®ã©ã¡ã‚‰ã‹ã‚’`revised_text_segment`ã«ä¿å­˜

### OpenAI APIç›´æ¥åˆ©ç”¨
- `openai_completion_step2.py`ã®ä¾å­˜ã‚’æ–­ã¡ã€é–¢æ•°å†…ã«ç›´æ¥è¨˜è¿°
- `get_naturalness_score()`é–¢æ•°ã‚’å®Ÿè£…
- è‡ªç„¶ã•ã‚¹ã‚³ã‚¢ï¼ˆ0.0ã€œ1.0ï¼‰ã‚’ç®—å‡º

### å‡¦ç†ã®éåŒæœŸåŒ–
- å„ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†æ™‚ã€æ¬¡ã®Queueã¸`send_queue_message()`ã‚’å®Ÿè¡Œ
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ã‚’å®Ÿè£…
- ãƒ­ã‚°ã®å……å®ŸåŒ–

### ç¾åœ¨ã®åˆ¤å®šå¯¾è±¡
- ChatGPTã«åˆ¤å®šã‚’ä¾é ¼ã—ã¦ã„ã‚‹ã‚«ãƒ©ãƒ : `merged_text_with_prev`ã¨`merged_text_with_next`
- ã“ã‚Œã‚‰ã®æ–‡è„ˆçµåˆå¾Œã®æ–‡ã‚’è©•ä¾¡ã—ã¦ã‚¹ã‚³ã‚¢ã‚’ç®—å‡ºã—ã€åˆ¤å®šã«ç”¨ã„ã‚‹

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- ã‚¹ã‚³ã‚¢ã¨å‰Šé™¤åˆ¤å®šã®æ•´åˆæ€§å‘ä¸Š
- æ¤œè¨¼æ€§ã®å‘ä¸Šï¼ˆè£œåŠ©ã‚«ãƒ©ãƒ ã«ã‚ˆã‚‹å‰å¾Œæ–‡è„ˆä¿æŒï¼‰
- å‡¦ç†ã®éåŒæœŸåŒ–ã«ã‚ˆã‚‹ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–
- ãƒ­ã‚°å‡ºåŠ›ã®è©³ç´°åŒ–

### ä»Šå¾Œã®èª²é¡Œ
- å„å‡ºåŠ›ãƒ†ãƒ¼ãƒ–ãƒ«ã®CREATE TABLEãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•´å‚™
- Pollingã‹ã‚‰ã®Queueé€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯æ•´ç†
- å…¨ã‚¹ãƒ†ãƒƒãƒ—ã®statusç®¡ç†ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒãƒªã‚·ãƒ¼è¨­è¨ˆ

## 2025å¹´1æœˆ27æ—¥ - ã‚¹ã‚³ã‚¢æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ï¼ˆdelete_candidate_word ã®ç”Ÿæˆæ¡ä»¶ã‚’æ­£ã—ãã™ã‚‹ï¼‰

### èƒŒæ™¯
- ç¾åœ¨ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ¡ä»¶ã§ delete_candidate_word ã®å…ƒæ–‡ã‚’æ±ºå®šã—ã¦ã„ã‚‹ï¼š
```python
if front_score <= after_score:
    delete_candidate_word = prev_last_sentence
else:
    delete_candidate_word = next_first_sentence
```
- ã“ã‚Œã¯ ã‚¹ã‚³ã‚¢ãŒé«˜ã„æ–¹ï¼ˆã‚ˆã‚Šè‡ªç„¶ãªæ–‡ï¼‰ã‚’é¸ã¶ãƒ­ã‚¸ãƒƒã‚¯ã¨ã—ã¦ã¯èª¤ã£ã¦ã„ã‚‹
- æœ¬æ¥ã¯ ã‚¹ã‚³ã‚¢ãŒé«˜ã„å´ã® merged_text ãŒæ¡ç”¨ã•ã‚Œã€ãã®æ§‹æˆå…ƒæ–‡ãŒ delete_candidate_word ã«å…¥ã‚‹ã¹ã

### ä¿®æ­£å†…å®¹

#### 1. QueuePreprocessingFunc å†…ã®ã‚¹ã‚³ã‚¢æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
- **ä¿®æ­£å‰**: `if front_score <= after_score:` â†’ å‰æ–‡ã®æœ€å¾Œã®æ–‡ã‚’å‰Šé™¤å€™è£œ
- **ä¿®æ­£å¾Œ**: `if front_score > after_score:` â†’ å‰æ–‡ã®æœ€å¾Œã®æ–‡ã‚’å‰Šé™¤å€™è£œ
- **ä¿®æ­£å‰**: `else:` â†’ å¾Œæ–‡ã®æœ€åˆã®æ–‡ã‚’å‰Šé™¤å€™è£œ  
- **ä¿®æ­£å¾Œ**: `else:` â†’ å¾Œæ–‡ã®æœ€åˆã®æ–‡ã‚’å‰Šé™¤å€™è£œ

#### 2. QueueMergingAndCleanupFunc å†…ã®ã‚¹ã‚³ã‚¢æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
- **ä¿®æ­£å‰**: `if front_score <= after_score:` â†’ merged_text_with_prev ã‚’é¸æŠ
- **ä¿®æ­£å¾Œ**: `if front_score > after_score:` â†’ merged_text_with_prev ã‚’é¸æŠ

#### 3. æ­£ã—ã„æ¡ä»¶åˆ†å²ã®ãƒ­ã‚¸ãƒƒã‚¯
```python
if front_score > after_score:
    # ã‚ˆã‚Šè‡ªç„¶ãªã®ã¯å‰æ–‡æ¥ç¶š â†’ å‰æ–‡ã®æœ€å¾Œã®æ–‡ã‚’ delete_candidate_word ã«
    delete_candidate_word = prev_last_sentence
else:
    # ã‚ˆã‚Šè‡ªç„¶ãªã®ã¯å¾Œæ–‡æ¥ç¶š â†’ å¾Œæ–‡ã®æœ€åˆã®æ–‡ã‚’ delete_candidate_word ã«
    delete_candidate_word = next_first_sentence
```

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **ãƒ­ã‚¸ãƒƒã‚¯æ•´åˆæ€§**: ã‚¹ã‚³ã‚¢ãŒé«˜ã„æ–¹ï¼ˆã‚ˆã‚Šè‡ªç„¶ãªæ–¹ï¼‰ã® merged_text ãŒæ¡ç”¨ã•ã‚Œã‚‹
- **å‰Šé™¤å€™è£œã®æ­£ç¢ºæ€§**: æ¡ç”¨ã•ã‚ŒãŸ merged_text ã®æ§‹æˆå…ƒæ–‡ãŒæ­£ã—ã delete_candidate_word ã«æ ¼ç´ã•ã‚Œã‚‹
- **ãƒ•ã‚£ãƒ©ãƒ¼å‡¦ç†ã®ç²¾åº¦å‘ä¸Š**: ã‚ˆã‚Šè‡ªç„¶ãªæ–‡è„ˆã‚’ä¿æŒã—ã€ä¸è‡ªç„¶ãªéƒ¨åˆ†ã®ã¿ã‚’å‰Šé™¤å¯¾è±¡ã¨ã™ã‚‹

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ
- ãƒ•ã‚£ãƒ©ãƒ¼å‰Šé™¤å‡¦ç†ã®ç²¾åº¦å‘ä¸Š
- è‡ªç„¶ãªæ–‡è„ˆã®ä¿æŒ
- ä¸é©åˆ‡ãªå‰Šé™¤å€™è£œã®é¸æŠã‚’é˜²æ­¢

## 2025å¹´1æœˆ27æ—¥ - delete_candidate_word ã«æ ¼ç´ã™ã‚‹èªå¥ã®èªå°¾ã«ã€Œã€‚ã€ã‚’è¿½åŠ 

### èƒŒæ™¯
- delete_candidate_word ã¯ã€è£œå®Œã«ä½¿ã‚ã‚ŒãŸå‰å¾Œã®æ–‡ã®ä¸€éƒ¨ã‚’å‰Šé™¤å¯¾è±¡ã¨ã—ã¦è¨˜éŒ²ã™ã‚‹ã‚«ãƒ©ãƒ 
- å®Ÿéš›ã®æ–‡æœ«ã«ã¯ã€Œã€‚ã€ãŒã¤ã„ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ãŒã»ã¨ã‚“ã©ã§ã‚ã‚Šã€æ•´åˆæ€§ãƒ»è‡ªç„¶ã•ã®è¦³ç‚¹ã‹ã‚‰ã‚‚èªå°¾ã®å¥ç‚¹ã‚’æ˜ç¤ºçš„ã«è¿½åŠ ã™ã¹ã
- è£œå®Œå¯¾è±¡ã«ä½¿ã‚ã‚ŒãŸèªå¥ãŒå¥ç‚¹ç„¡ã—ã§è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã¨ã€å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ã®åˆ¤å®šãƒŸã‚¹ã‚„å‰Šé™¤ç²¾åº¦ã®ä½ä¸‹ã«ã¤ãªãŒã‚‹

### ä¿®æ­£å†…å®¹

#### 1. QueuePreprocessingFunc å†…ã® delete_candidate_word ç”Ÿæˆå‡¦ç†ä¿®æ­£
- **ä¿®æ­£å‰**: `delete_candidate = prev_last_sentence` / `delete_candidate = next_first_sentence`
- **ä¿®æ­£å¾Œ**: `delete_candidate = prev_last_sentence.rstrip("ã€‚") + "ã€‚"` / `delete_candidate = next_first_sentence.rstrip("ã€‚") + "ã€‚"`

#### 2. èªå°¾å¥ç‚¹ã®çµ±ä¸€å‡¦ç†
```python
# æ—¢ã«å¥ç‚¹ãŒå«ã¾ã‚Œã¦ã„ãŸå ´åˆã®äºŒé‡ä»˜ä¸ã‚’é˜²ããŸã‚ã€.rstrip("ã€‚") ã§ä¸€æ—¦é™¤å»ã—ã¦ã‹ã‚‰ä»˜ã‘ç›´ã™
delete_candidate = prev_last_sentence.rstrip("ã€‚") + "ã€‚"
delete_candidate = next_first_sentence.rstrip("ã€‚") + "ã€‚"
```

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **æ•´åˆæ€§å‘ä¸Š**: å¸¸ã«æ–‡ã¨ã—ã¦é–‰ã˜ãŸå½¢ã§è¨˜éŒ²ã•ã‚Œã‚‹
- **å‰Šé™¤ç²¾åº¦å‘ä¸Š**: å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ã®åˆ¤å®šãƒŸã‚¹ã‚’é˜²æ­¢
- **è‡ªç„¶ã•ä¿æŒ**: å®Ÿéš›ã®æ–‡æ§‹é€ ã«è¿‘ã„å½¢ã§å‰Šé™¤å€™è£œã‚’è¨˜éŒ²

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ
- ãƒ•ã‚£ãƒ©ãƒ¼å‰Šé™¤å‡¦ç†ã®ç²¾åº¦å‘ä¸Š
- å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ã®åˆ¤å®šãƒŸã‚¹é˜²æ­¢
- å‰Šé™¤å€™è£œã®æ•´åˆæ€§ç¢ºä¿

## 2025å¹´1æœˆ27æ—¥ - QueueMergingAndCleanupFunc ã®æ•´åˆæ€§ç¢ºèªã¨ä¿®æ­£å¯¾å¿œ

### èƒŒæ™¯
- QueuePreprocessingFunc ã®å‡ºåŠ›æ§‹é€ ãŒå¤‰æ›´ã•ã‚Œã€ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ãŒ TranscriptProcessingSegments ã«è¿½åŠ ã•ã‚ŒãŸï¼š
  - `merged_text_with_prev`
  - `merged_text_with_next`
  - `delete_candidate_word`
  - `front_score`
  - `after_score`
- æ—§ã‚«ãƒ©ãƒ  `revised_text_segment` ã¯å»ƒæ­¢ã•ã‚ŒãŸ
- QueueMergingAndCleanupFunc ã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ãŒå¿…è¦

### ä¿®æ­£å†…å®¹

#### 1. revised_text_segment ã®å‚ç…§ç¢ºèª
- **ç¢ºèªçµæœ**: ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ revised_text_segment ã‚’ç›´æ¥å‚ç…§ã—ã¦ã„ãªã„ãŸã‚ã€å‰Šé™¤ä¸è¦
- **å¯¾å¿œ**: ä»Šå¾Œã‚‚ä½¿ç”¨ç¦æ­¢ã‚’ç¶™ç¶š

#### 2. merged_text_with_prev/next ã®æ´»ç”¨å¼·åŒ–
- **ä¿®æ­£å‰**: æ¬¡ã®è¡Œã®filleræƒ…å ±ã®ã¿ã‚’å–å¾—
- **ä¿®æ­£å¾Œ**: ç¾åœ¨ã®è¡Œã® merged_text_with_prev/next ã‚’å„ªå…ˆçš„ã«æ´»ç”¨
- **ãƒ­ã‚¸ãƒƒã‚¯**: 
  ```python
  if front_score > after_score and merged_text_with_prev and merged_text_with_prev.strip():
      current_merged_text = merged_text_with_prev
  elif merged_text_with_next and merged_text_with_next.strip():
      current_merged_text = merged_text_with_next
  ```

#### 3. delete_candidate_word ã®æ´»ç”¨ç¢ºèª
- **ç¢ºèªçµæœ**: ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã§æ­£ã—ãæ´»ç”¨ã•ã‚Œã¦ã„ã‚‹
- **å‡¦ç†**: `transcript_text.replace(delete_word or "", "")` ã§ä¸è¦ãªèªå¥ã‚’å‰Šé™¤

#### 4. ç©ºæ–‡å­—å¯¾ç­–ã®å®Ÿè£…
- **è¿½åŠ **: `merged_text_with_prev/next` ãŒç©ºã®å ´åˆã®å‡¦ç†ä¾‹å¤–ã‚’å®Ÿè£…
- **å¯¾ç­–**: `.strip()` ã«ã‚ˆã‚‹ç©ºæ–‡å­—ãƒã‚§ãƒƒã‚¯ã¨æ¡ä»¶åˆ†å²ã®è¿½åŠ 
- **ãƒ­ã‚°**: ç©ºæ–‡å­—ã®å ´åˆã®è­¦å‘Šãƒ­ã‚°ã‚’è¿½åŠ 

#### 5. ãƒ­ã‚°ã®å……å®ŸåŒ–
- **è¿½åŠ ãƒ­ã‚°**:
  - `[MERGING] Processing line {line_no}, speaker={speaker}`
  - `[MERGING] Using merged_text_with_prev/next`
  - `[MERGING] Using current_merged_text/next_merged_text/original text`
  - `[DB] Inserted ProcessedTranscriptSegment`
  - `[CLEANUP] Processing segment_id={segment_id}`
  - `[CLEANUP] Cleaned text`
  - `[DB] Updated ProcessedTranscriptSegment`

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ã®æœ€é©åŒ–**: ç¾åœ¨ã®è¡Œã® merged_text_with_prev/next ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
- **ç©ºæ–‡å­—å¯¾ç­–**: å„æ®µéšã§ç©ºæ–‡å­—ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…
- **ãƒ­ã‚°ã®è©³ç´°åŒ–**: å‡¦ç†éç¨‹ã®å¯è¦–æ€§å‘ä¸Š
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å„æ®µéšã§ã®ä¾‹å¤–å‡¦ç†å¼·åŒ–

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ
- ãƒ•ã‚£ãƒ©ãƒ¼å‡¦ç†ã®ç²¾åº¦å‘ä¸Š
- ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºä¿
- å‡¦ç†éç¨‹ã®å¯è¦–æ€§å‘ä¸Š
- ã‚¨ãƒ©ãƒ¼åŸå› ã®ç‰¹å®šå®¹æ˜“åŒ–

## 2025å¹´1æœˆ27æ—¥ - QueueMergingAndCleanupFunc å†…ã§ã®ãƒ•ã‚£ãƒ©ãƒ¼å‰Šé™¤å‡¦ç†ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–

### èƒŒæ™¯
- ç¾åœ¨ã®QueueMergingAndCleanupFuncã§ã¯ `from openai_processing.openai_completion_step6 import remove_fillers_from_text` ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹
- å°†æ¥çš„ã« `openai_completion_step6.py` ã¯å»ƒæ­¢äºˆå®š
- ä¾å­˜é–¢ä¿‚ã‚’æ¸›ã‚‰ã—ã€é–¢æ•°å†…ã«ç›´æ¥å®Ÿè£…ã™ã‚‹ã“ã¨ã§ä¿å®ˆæ€§ã‚’å‘ä¸Š

### ä¿®æ­£å†…å®¹

#### 1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã®å‰Šé™¤
- **ä¿®æ­£å‰**: `from openai_processing.openai_completion_step6 import remove_fillers_from_text`
- **ä¿®æ­£å¾Œ**: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã‚’å‰Šé™¤ã—ã€é–¢æ•°å†…ã«ç›´æ¥å®Ÿè£…

#### 2. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°ã®å®Ÿè£…
- **é–¢æ•°å**: `remove_fillers_from_text_inline()`
- **æ©Ÿèƒ½**: ã‚‚ã¨ã‚‚ã¨ã® `remove_fillers_from_text()` ã¨å®Œå…¨ã«åŒã˜
- **å†…å®¹**:
  - ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ãƒ•ã‚£ãƒ©ãƒ¼å‰Šé™¤ã®è©³ç´°ãªæŒ‡ç¤º
  - å¯¾è±¡ãƒ•ã‚£ãƒ©ãƒ¼: ã€Œãˆã£ã¨ã€ã€Œã‚ã®ã€ã€Œã¾ã‚ã€ã€Œãã®ã€ã€Œã§ã™ã‘ã©ã€ãªã©
  - æ³¨æ„äº‹é …: è‡ªç„¶ãªä¼šè©±ã®æµã‚Œã‚’å´©ã•ãªã„
  - å‡ºåŠ›: ä¿®æ­£å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆã®ã¿

#### 3. OpenAI APIå‘¼ã³å‡ºã—ã®å®Ÿè£…
```python
response = client.chat.completions.create(
    model=os.environ.get("OPENAI_MODEL", "gpt-3.5-turbo"),
    messages=[
        {"role": "system", "content": system_message},
        {"role": "user", "content": user_message}
    ],
    temperature=0.1,  # ä½ã„æ¸©åº¦ã§ä¸€è²«æ€§ã‚’ä¿ã¤
    max_tokens=200    # çŸ­ã„å¿œç­”ã«åˆ¶é™
)
```

#### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¶­æŒ
- **ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡è¨˜éŒ²**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã§å®Ÿè£…
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½**: ä¾‹å¤–ç™ºç”Ÿæ™‚ã¯å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™
- **ãƒ­ã‚°å‡ºåŠ›**: å‡¦ç†éç¨‹ã®è©³ç´°ãªå¯è¦–åŒ–

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **ä¾å­˜é–¢ä¿‚ã®å‰Šæ¸›**: å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ä¾å­˜ã‚’æ’é™¤
- **ä¿å®ˆæ€§å‘ä¸Š**: é–¢æ•°å†…ã«å…¨ã¦ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒé›†ç´„
- **å°†æ¥æ€§ç¢ºä¿**: openai_completion_step6.py ã®å»ƒæ­¢ã«å‚™ãˆã‚‹
- **æ©Ÿèƒ½ã®å®Œå…¨ä¿æŒ**: ã‚‚ã¨ã‚‚ã¨ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’100%è¸è¥²

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ
- å¤–éƒ¨ä¾å­˜ã®å‰Šæ¸›
- ã‚³ãƒ¼ãƒ‰ã®è‡ªå·±å®Œçµæ€§å‘ä¸Š
- å°†æ¥ã®å»ƒæ­¢ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å¯¾å¿œ
- ä¿å®ˆæ€§ã®å‘ä¸Š

## 2025å¹´1æœˆ27æ—¥ - è‡ªç„¶ã•åˆ¤å®šã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ­ã‚°è¿½åŠ ã¨ã‚¹ã‚³ã‚¢ç•°å¸¸ã®åŸå› èª¿æŸ»ãƒ»ä¿®æ­£

### èƒŒæ™¯
- å…ƒã®Step2ï¼ˆopenai_completion_step2.pyï¼‰ã§ã¯è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›ãŒã‚ã£ãŸãŒã€QueuePreprocessingFuncçµ±åˆå¾Œã¯ãƒ­ã‚°ãŒä¸€åˆ‡å‡ºåŠ›ã•ã‚Œã¦ã„ãªã„
- `front_score`, `after_score`ãŒå¸¸ã«`0.5`ã®ã¾ã¾ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ãŒç™ºç”Ÿ
- OpenAI APIå¿œç­”ãŒæ­£ã—ãå–å¾—ãƒ»ãƒ‘ãƒ¼ã‚¹ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

### ä¿®æ­£å†…å®¹

#### 1. `get_naturalness_score()`é–¢æ•°ã®ãƒ­ã‚°å¼·åŒ–
- **è¿½åŠ ãƒ­ã‚°**:
  - `[OpenAI] Empty text detected, returning default score 0.5`
  - `[OpenAI] Evaluating text: '{text}'`
  - `[OpenAI] Raw response: {response}`
  - `[OpenAI] Extracted content: '{content}'`
  - `[OpenAI] Parsed score: {score}`
  - `[OpenAI] API call failed: {e}`
  - `[OpenAI] Response structure: {response}`

#### 2. ãƒ•ã‚£ãƒ©ãƒ¼åˆ¤å®šå‡¦ç†ã®ãƒ­ã‚°å¼·åŒ–
- **è¿½åŠ ãƒ­ã‚°**:
  - `[FILLER] meeting_id={meeting_id}, line_no={line_no}, text: '{text}'`
  - `[FILLER] Prev text (line {line_no - 1}): '{prev_text}'`
  - `[FILLER] Next text (line {line_no + 1}): '{next_text}'`
  - `[FILLER] Prev sentences: {prev_sentences}`
  - `[FILLER] merged_text_with_prev: '{merged_text_with_prev}'`
  - `[FILLER] Next sentences: {next_sentences}`
  - `[FILLER] merged_text_with_next: '{merged_text_with_next}'`
  - `[FILLER] Front score for merged_text_with_prev: {front_score}`
  - `[FILLER] Back score for merged_text_with_next: {back_score}`
  - `[FILLER] Final Scores - front: {front_score}, back: {back_score}`
  - `[FILLER] Updated line {line_no} with scores: front={front_score}, back={back_score}`

#### 3. è£œå®Œå€™è£œæŒ¿å…¥å‡¦ç†ã®ãƒ­ã‚°å¼·åŒ–
- **è¿½åŠ ãƒ­ã‚°**:
  - `[REVISION] meeting_id={meeting_id}, line_no={line_no}, front_score={front_score}, after_score={after_score}`
  - `[REVISION] merged_text_with_prev: '{merged_text_with_prev}'`
  - `[REVISION] merged_text_with_next: '{merged_text_with_next}'`
  - `[REVISION] Using merged_text_with_prev (front_score={front_score} <= after_score={after_score})`
  - `[REVISION] Using merged_text_with_next (front_score={front_score} > after_score={after_score})`
  - `[REVISION] revised_text: '{revised_text}', delete_candidate: '{delete_candidate}'`

### èª¿æŸ»ãƒã‚¤ãƒ³ãƒˆ
1. **ã‚¹ã‚³ã‚¢ãŒå¸¸ã«0.5ã«ãªã‚‹åŸå› èª¿æŸ»**
   - `openai.ChatCompletion.create()`ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£ã—ãå–å¾—ã§ãã¦ã„ã‚‹ã‹
   - `response['choices'][0]['message']['content']`ã«ã‚¹ã‚³ã‚¢ãŒæ­£ã—ãå«ã¾ã‚Œã¦ã„ã‚‹ã‹
   - `float(content)`ã®å¤‰æ›ã«å¤±æ•—ã—ã¦`except:`ãƒ–ãƒ­ãƒƒã‚¯ã§fallbackã®0.5ãŒè¿”ã£ã¦ã„ãªã„ã‹

2. **ãƒ­ã‚°å‡ºåŠ›ã®å¾©æ´»ãƒ»æ•´å‚™**
   - å„filleråˆ¤å®šå¯¾è±¡è¡Œã«ã¤ã„ã¦è©³ç´°ãªãƒ­ã‚°ã‚’è¿½åŠ 
   - meeting_idä»˜åŠ ã§å€‹åˆ¥ãƒ†ã‚¹ãƒˆæ™‚ã®ç‰¹å®šã‚’å®¹æ˜“åŒ–
   - è©•ä¾¡å¯¾è±¡æ–‡ãƒ»å¿œç­”å†…å®¹ãƒ»ã‚¹ã‚³ã‚¢ã®ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ç¢ºä¿

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **ãƒ‡ãƒãƒƒã‚°æ€§å‘ä¸Š**: ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’çµ±ä¸€ã—ã€å•é¡Œç®‡æ‰€ã®ç‰¹å®šã‚’å®¹æ˜“åŒ–
- **ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ç¢ºä¿**: è©•ä¾¡å¯¾è±¡æ–‡ã‹ã‚‰ã‚¹ã‚³ã‚¢ç®—å‡ºã¾ã§ã®å…¨éç¨‹ã‚’ãƒ­ã‚°åŒ–
- **ã‚¨ãƒ©ãƒ¼åŸå› ç‰¹å®š**: OpenAI APIå¿œç­”ã®è©³ç´°ãƒ­ã‚°ã§ç•°å¸¸ã®æ—©æœŸç™ºè¦‹
- **æ¤œè¨¼æ€§å‘ä¸Š**: å®Ÿéš›ã«ã©ã¡ã‚‰ã®æ–‡ãŒè©•ä¾¡å¯¾è±¡ã«ãªã£ã¦ã„ã‚‹ã‹ãŒæ˜ç¢ºåŒ–

### æœ€çµ‚ç›®çš„
- ã‚¹ã‚³ã‚¢ãŒå¸¸ã«0.5ã«ãªã‚‹ç•°å¸¸ã‚’æ—©æœŸã«ç‰¹å®šãƒ»ä¿®æ­£
- è©•ä¾¡å¯¾è±¡æ–‡ãƒ»å¿œç­”å†…å®¹ãƒ»ã‚¹ã‚³ã‚¢ã®ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿
- è‡ªç„¶ã•è©•ä¾¡ã®ç²¾åº¦æ”¹å–„ã«æ´»ç”¨

## 2025å¹´1æœˆ27æ—¥ - OpenAI APIå‘¼ã³å‡ºã—å½¢å¼ã®æ–°ä»•æ§˜å¯¾å¿œ

### èƒŒæ™¯
- ç¾åœ¨ã®å®Ÿè£…ã§ã¯`openai.ChatCompletion.create()`ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã“ã‚Œã¯`openai>=1.0.0`ã§ã¯éå¯¾å¿œ
- ãã®ãŸã‚ã€APIå‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ã€ã‚¹ã‚³ã‚¢ãŒå¸¸ã«fallbackã®`0.5`ã«ãªã£ã¦ã„ã‚‹
- ä¸€æ–¹ã€`openai_completion_step2.py`å´ã®`client.chat.completions.create()`ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹

### ä¿®æ­£å†…å®¹

#### 1. `get_naturalness_score()`é–¢æ•°ã®æ–°ä»•æ§˜å¯¾å¿œ
- **ä¿®æ­£å‰**: `openai.ChatCompletion.create()`ã‚’ä½¿ç”¨
- **ä¿®æ­£å¾Œ**: `openai.OpenAI()`ã‹ã‚‰clientã‚’åˆæœŸåŒ–ã—ã€`client.chat.completions.create()`ã‚’ä½¿ç”¨

#### 2. APIå‘¼ã³å‡ºã—å½¢å¼ã®å¤‰æ›´
```python
# ä¿®æ­£å‰
response = openai.ChatCompletion.create(
    model=os.getenv("OPENAI_MODEL", "gpt-3.5-turbo"),
    messages=[...],
    temperature=0
)
content = response['choices'][0]['message']['content'].strip()

# ä¿®æ­£å¾Œ
client = openai.OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))
response = client.chat.completions.create(
    model=os.environ.get("OPENAI_MODEL", "gpt-3.5-turbo"),
    messages=[...],
    temperature=0
)
content = response.choices[0].message.content.strip()
```

#### 3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ”¹å–„
- **ä¿®æ­£å‰**: ã€Œä¸è‡ªç„¶ãªèªé †ã€æ„å‘³ã®ä¸æ˜ç­ã•ã€æ¥ç¶šã®ãã“ã¡ãªã•ãŒã‚ã‚‹å ´åˆã¯ä½ã„ã‚¹ã‚³ã‚¢ã¨ã—ã¦ãã ã•ã„ã€
- **ä¿®æ­£å¾Œ**: ã€Œèªé †ã€æ„å‘³ã®æµã‚Œã€æ–‡è„ˆã®ã¤ãªãŒã‚Šã‚’è€ƒæ…®ã—ã€

#### 4. ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„
- **ä¿®æ­£å‰**: ã€Œã‚ãªãŸã¯æ—¥æœ¬èªã®æ–‡ã®è‡ªç„¶ã•ã‚’æ¡ç‚¹ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã€
- **ä¿®æ­£å¾Œ**: ã€Œã‚ãªãŸã¯æ—¥æœ¬èªã®æ–‡ã®è‡ªç„¶ã•ã‚’è©•ä¾¡ã™ã‚‹AIã§ã™ã€‚ã€

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **äº’æ›æ€§å‘ä¸Š**: `openai>=1.0.0`ã«å¯¾å¿œã—ãŸAPIå‘¼ã³å‡ºã—å½¢å¼
- **ã‚¨ãƒ©ãƒ¼è§£æ±º**: APIå‘¼ã³å‡ºã—å¤±æ•—ã«ã‚ˆã‚‹ã‚¹ã‚³ã‚¢ç•°å¸¸ã®ä¿®æ­£
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†**: æ–°ã—ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ï¼ˆ`response.choices[0].message.content`ï¼‰ã«å¯¾å¿œ
- **ãƒ­ã‚°ç¶­æŒ**: è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›ã‚’ç¶­æŒã—ã€ãƒ‡ãƒãƒƒã‚°æ€§ã‚’ç¢ºä¿

### æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ
- ã‚¹ã‚³ã‚¢ãŒå¸¸ã«0.5ã«ãªã‚‹å•é¡Œã®è§£æ±º
- OpenAI APIã®æ­£å¸¸ãªå‘¼ã³å‡ºã—ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹å–å¾—
- è‡ªç„¶ã•è©•ä¾¡ã®ç²¾åº¦å‘ä¸Š
- ä»–ã®OpenAI APIå‘¼ã³å‡ºã—ç®‡æ‰€ã¨ã®ä¸€è²«æ€§ç¢ºä¿

## 2025å¹´1æœˆ27æ—¥ - TranscriptProcessingSegmentsãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®æŒ¿å…¥ç¢ºèªãƒ­ã‚°è¿½åŠ ã¨ã‚¹ã‚³ã‚¢é–¢é€£ã®å†—é•·ãªãƒ­ã‚°å‰Šé™¤

### èƒŒæ™¯
- `QueuePreprocessingFunc`ã‚’å®Ÿè¡Œã—ã¦ã‚‚`TranscriptProcessingSegments`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒ0ä»¶ã®ã¾ã¾ã§ã‚ã‚‹äº‹è±¡ãŒç™ºç”Ÿ
- INSERTãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã€meeting_idã”ã¨ã«ç¢ºèªã§ãã‚‹ã‚ˆã†ãƒ­ã‚°ã‚’è¿½åŠ ã—ãŸã„
- ä¸€æ–¹ã§ã€ã‚¹ã‚³ã‚¢ï¼ˆfront_score / after_scoreï¼‰ã®å‡ºåŠ›ã¯æ­£å¸¸ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ããŸãŸã‚ã€ãã‚Œã«é–¢ã™ã‚‹ãƒ­ã‚°ã¯å‰Šé™¤ã—ã¦OK

### ä¿®æ­£å†…å®¹

#### 1. INSERTå®Ÿè¡Œç¢ºèªãƒ­ã‚°ã®è¿½åŠ 
- **è¿½åŠ ãƒ­ã‚°**: `[DB] Inserted TranscriptProcessingSegment: meeting_id={meeting_id}, line_no={line_no}, speaker={speaker}`
- **ä½ç½®**: `INSERT INTO TranscriptProcessingSegments`ã®ã™ãä¸‹ã«è¿½åŠ 
- **åŠ¹æœ**: å‡¦ç†å¯¾è±¡ã®è¡ŒãŒå®Ÿéš›ã«DBã«è¿½åŠ ã•ã‚ŒãŸã“ã¨ãŒãƒ­ã‚°ã§ç¢ºèªå¯èƒ½

#### 2. ã‚¹ã‚³ã‚¢é–¢é€£ã®å†—é•·ãªãƒ­ã‚°å‰Šé™¤
- **å‰Šé™¤å¯¾è±¡**:
  - `[OpenAI] Empty text detected, returning default score 0.5`
  - `[OpenAI] Evaluating text: '{text}'`
  - `[OpenAI] Raw response: {response}`
  - `[OpenAI] Extracted content: '{content}'`
  - `[OpenAI] Parsed score: {score}`
  - `[OpenAI] Response structure: {response}`
  - `[FILLER] Front score for merged_text_with_prev: {front_score}`
  - `[FILLER] Back score for merged_text_with_next: {back_score}`
  - `[FILLER] Final Scores - front: {front_score}, back: {back_score}`
  - `[REVISION] merged_text_with_prev: '{merged_text_with_prev}'`
  - `[REVISION] merged_text_with_next: '{merged_text_with_next}'`
  - `[REVISION] revised_text: '{revised_text}', delete_candidate: '{delete_candidate}'`

#### 3. ãƒ­ã‚°ã®ç°¡ç´ åŒ–
- **ä¿æŒãƒ­ã‚°**:
  - `[FILLER] Processing line {line_no}, text: '{text}'`
  - `[FILLER] Updated line {line_no} with scores: front={front_score}, back={back_score}`
  - `[REVISION] Processing line {line_no}, front_score={front_score}, after_score={after_score}`
  - ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ã‚°ï¼ˆ`[OpenAI] API call failed: {e}`ãªã©ï¼‰

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **ãƒ‡ãƒãƒƒã‚°åŠ¹ç‡å‘ä¸Š**: INSERTå‡¦ç†ã®å¯è¦–åŒ–ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œãªã„å•é¡Œã‚’æ­£ç¢ºã«ãƒˆãƒ¬ãƒ¼ã‚¹å¯èƒ½
- **ãƒ­ã‚°å¯èª­æ€§å‘ä¸Š**: ä¸è¦ãªãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¦ã€é‡è¦ãªæƒ…å ±ã«é›†ä¸­
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š**: å†—é•·ãªãƒ­ã‚°å‡ºåŠ›ã‚’å‰Šæ¸›
- **å•é¡Œç‰¹å®šã®å®¹æ˜“åŒ–**: meeting_idä»˜åŠ ã§å€‹åˆ¥ãƒ†ã‚¹ãƒˆæ™‚ã®ç‰¹å®šã‚’å®¹æ˜“åŒ–

### ç›®çš„
- INSERTå‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã®å¯è¦–åŒ–ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œãªã„å•é¡Œã‚’æ­£ç¢ºã«ãƒˆãƒ¬ãƒ¼ã‚¹å¯èƒ½ã«ã™ã‚‹
- ä¸è¦ãªãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¦ã€ãƒ­ã‚°å…¨ä½“ã®å¯èª­æ€§ã¨ãƒ‡ãƒãƒƒã‚°åŠ¹ç‡ã‚’é«˜ã‚ã‚‹

## 2025å¹´1æœˆ27æ—¥ - revised_text_segmentã‚«ãƒ©ãƒ ã®ä½¿ç”¨åœæ­¢ã¨delete_candidate_wordã®ç›®çš„å¤‰æ›´

### èƒŒæ™¯
- `revised_text_segment`ã¯ã€`merged_text_with_prev`ã¾ãŸã¯`merged_text_with_next`ã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã¨å¸¸ã«åŒã˜å†…å®¹ã§ã‚ã‚Šã€å†—é•·
- ã¾ãŸã€è£œå®Œå¾Œã®é¸æŠæ–‡ã¯æ˜ç¤ºçš„ã«ã‚¹ã‚³ã‚¢ã«ã‚ˆã£ã¦æ±ºã¾ã‚‹ãŸã‚ã€å¿…è¦ã§ã‚ã‚Œã°ãã®å ´ã§å‹•çš„ã«å–å¾—å¯èƒ½
- ã‚«ãƒ©ãƒ ã‚’æ®‹ã—ã¦ãŠãã“ã¨ã§ã€èª¤ã£ã¦å‡¦ç†å¯¾è±¡ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹
- ãƒ•ã‚£ãƒ©ãƒ¼å‡¦ç†å¾Œã«ã€å…ƒã®`transcript_text_segment`ã«å«ã¾ã‚Œã‚‹è£œåŠ©çš„ãªèªå¥ï¼ˆä¾‹ï¼šã€Œå¤§ä¸ˆã€‚ã€ãªã©ã®è¨€ã„ã‚ˆã©ã¿ï¼‰ãŒæ–‡ä¸­ã«æ®‹ã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹

### ä¿®æ­£å†…å®¹

#### 1. `revised_text_segment`ã‚«ãƒ©ãƒ ã®ä½¿ç”¨åœæ­¢
- **ä¿®æ­£å‰**: `revised_text_segment`ã«é¸æŠã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
- **ä¿®æ­£å¾Œ**: `revised_text_segment`ã¸ã®UPDATEå‡¦ç†ã‚’ã™ã¹ã¦å‰Šé™¤
- **ç†ç”±**: `merged_text_with_prev`/`merged_text_with_next`ã§ä»£æ›¿å¯èƒ½

#### 2. `delete_candidate_word`ã®ç›®çš„å¤‰æ›´
- **ä¿®æ­£å‰**: å‰å¾Œã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‹ã‚‰å‰Šé™¤ã™ã‚‹æ–‡ã‚’è¨˜éŒ²
- **ä¿®æ­£å¾Œ**: è£œå®Œã«ã‚ˆã‚Šä¸è¦ã¨ãªã‚‹æ®‹ç•™èªå¥ã‚’è¨˜éŒ²
- **å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯**:
  ```python
  # å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰é¸æŠã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’é™¤ã„ãŸæ®‹ã‚Šã‚’å‰Šé™¤å€™è£œã¨ã™ã‚‹
  if selected_text in original_text:
      delete_candidate_word = original_text.replace(selected_text, "").strip()
  else:
      delete_candidate_word = bracket_text  # é¸æŠãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®æ‹¬å¼§å†…ãƒ†ã‚­ã‚¹ãƒˆ
  ```

#### 3. QueueMergingAndCleanupFuncã®ä¿®æ­£
- **ä¿®æ­£å‰**: `revised_text_segment`ã‚’å‚ç…§ã—ã¦è£œå®Œãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
- **ä¿®æ­£å¾Œ**: `merged_text_with_prev`/`merged_text_with_next`ã¨ã‚¹ã‚³ã‚¢ã‚’å‚ç…§ã—ã¦å‹•çš„ã«é¸æŠ
- **å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯**:
  ```python
  # ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦é¸æŠã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨
  if front_score <= after_score:
      next_merged_text = next_segment[3]  # merged_text_with_prev
  else:
      next_merged_text = next_segment[4]  # merged_text_with_next
  ```

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®ç°¡ç´ åŒ–**: å†—é•·ãªã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ã—ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’å‘ä¸Š
- **å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã®æ˜ç¢ºåŒ–**: ã‚¹ã‚³ã‚¢ã«åŸºã¥ãé¸æŠãƒ­ã‚¸ãƒƒã‚¯ã‚’å‹•çš„ã«å®Ÿè¡Œ
- **æ®‹ç•™èªå¥ã®é™¤å»**: è£œå®Œå¾Œã«æ®‹ã‚‹ä¸è¦ãªæ–­ç‰‡èªã‚’è‡ªå‹•å‰Šé™¤
- **ä¿å®ˆæ€§ã®å‘ä¸Š**: å‡¦ç†ã¨ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®ç°¡ç´ åŒ–ã«ã‚ˆã‚Šã€è£œå®Œãƒ­ã‚¸ãƒƒã‚¯ã®ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Š

### ç›®çš„
- å‡¦ç†ã¨ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®ç°¡ç´ åŒ–ã«ã‚ˆã‚Šã€è£œå®Œãƒ­ã‚¸ãƒƒã‚¯ã®ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Šã•ã›ã‚‹
- è£œå®Œå¾Œã®æ•´å½¢çµæœã«ä¸è¦ãªæ–­ç‰‡èªãŒæ®‹ã‚‹ã“ã¨ã‚’é˜²æ­¢ã—ã€æœ€çµ‚çš„ãªMergingAndCleanupStepã«ã‚ˆã‚‹å‰Šé™¤å‡¦ç†ã¨é€£æºã™ã‚‹ãŸã‚ã®ä¸­é–“æƒ…å ±ã‚’è¨˜éŒ²ã™ã‚‹

## 2025å¹´1æœˆ27æ—¥ - delete_candidate_wordã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£

### èƒŒæ™¯
- `delete_candidate_word`ã¯ã“ã‚Œã¾ã§èª¤ã£ã¦ãƒ•ã‚£ãƒ©ãƒ¼è‡ªèº«ï¼ˆtranscript_text_segmentï¼‰ã‚’æ ¼ç´ã—ã¦ã„ãŸ
- æœ¬æ¥ã¯ã€Œè£œå®Œã«ä½¿ã‚ã‚ŒãŸå‘¨è¾ºæ–‡ï¼ˆmerged_text_with_prev / next ã®æ§‹æˆå…ƒï¼‰ã€ã‚’æ˜ç¤ºçš„ã«è¨˜éŒ²ã™ã‚‹ç›®çš„ã§ä½¿ç”¨ã™ã‚‹
- è£œå®Œã«ä½¿ã‚ã‚ŒãŸæ–‡ã®æ§‹æˆå…ƒã‚’æ­£ç¢ºã«ç‰¹å®šã—ã€å¾Œç¶šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã§å‰Šé™¤å¯¾è±¡ã‚’æ˜ç¢ºã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### ä¿®æ­£å†…å®¹

#### 1. `delete_candidate_word`ã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´
- **ä¿®æ­£å‰**: å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰é¸æŠã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’é™¤ã„ãŸæ®‹ã‚Šã‚’å‰Šé™¤å€™è£œã¨ã™ã‚‹
- **ä¿®æ­£å¾Œ**: è£œå®Œã«ä½¿ã‚ã‚ŒãŸæ–‡ã®æ§‹æˆå…ƒã‚’ç›´æ¥æ ¼ç´ã™ã‚‹

#### 2. å‡¦ç†ãƒ«ãƒ¼ãƒ«ã®æ˜ç¢ºåŒ–
| æ¡ç”¨ã•ã‚ŒãŸè£œå®Œæ–¹å‘ | delete_candidate_word ã«æ ¼ç´ã™ã‚‹å†…å®¹ |
|-------------------|--------------------------------------|
| `merged_text_with_prev` æ¡ç”¨æ™‚ | conversation_segments[i-1]['text'] ã® **æœ€å¾Œã®æ–‡**ï¼ˆmerged_text_with_prev ä½œæˆæ™‚ã«ä½¿ç”¨ï¼‰ |
| `merged_text_with_next` æ¡ç”¨æ™‚ | conversation_segments[i+1]['text'] ã® **æœ€åˆã®æ–‡**ï¼ˆmerged_text_with_next ä½œæˆæ™‚ã«ä½¿ç”¨ï¼‰ |

#### 3. å®Ÿè£…ãƒ­ã‚¸ãƒƒã‚¯
```python
# å‰å¾Œã®æ–‡ã‹ã‚‰æ§‹æˆå…ƒã‚’æŠ½å‡º
prev_last_sentence = ""
next_first_sentence = ""

if prev_text and prev_text.strip():
    prev_sentences = [s.strip() for s in prev_text.strip().split("ã€‚") if s.strip()]
    if prev_sentences:
        prev_last_sentence = prev_sentences[-1]

if next_text and next_text.strip():
    next_sentences = [s.strip() for s in next_text.strip().split("ã€‚") if s.strip()]
    if next_sentences:
        next_first_sentence = next_sentences[0]

# ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦è£œå®Œã«ä½¿ã‚ã‚ŒãŸæ–‡ã‚’ç‰¹å®šã—ã€ãã®æ§‹æˆå…ƒã‚’delete_candidate_wordã«æ ¼ç´
if front_score <= after_score:
    # front_scoreãŒä½ã„ï¼ˆä¸è‡ªç„¶ï¼‰â†’ merged_text_with_prevãŒæ¡ç”¨ã•ã‚ŒãŸ
    delete_candidate = prev_last_sentence  # å‰ã®æ–‡ã®æœ€å¾Œã®æ–‡ã‚’å‰Šé™¤å€™è£œã¨ã™ã‚‹
else:
    # after_scoreãŒä½ã„ï¼ˆä¸è‡ªç„¶ï¼‰â†’ merged_text_with_nextãŒæ¡ç”¨ã•ã‚ŒãŸ
    delete_candidate = next_first_sentence  # æ¬¡ã®æ–‡ã®æœ€åˆã®æ–‡ã‚’å‰Šé™¤å€™è£œã¨ã™ã‚‹
```

### æŠ€è¡“çš„æ”¹å–„ç‚¹
- **æ­£ç¢ºæ€§ã®å‘ä¸Š**: è£œå®Œã«ä½¿ã‚ã‚ŒãŸæ–‡ã®æ§‹æˆå…ƒã‚’æ­£ç¢ºã«ç‰¹å®š
- **ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã®ç¢ºä¿**: ã©ã®æ–‡ãŒè£œå®Œã«ä½¿ã‚ã‚Œã€ã©ã®æ–‡ãŒå‰Šé™¤å¯¾è±¡ã‹ã‚’æ˜ç¢ºåŒ–
- **å‡¦ç†ã®ä¸€è²«æ€§**: merged_text_with_prev/nextã®ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¨é€£å‹•
- **å¾Œç¶šå‡¦ç†ã¨ã®é€£æº**: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã§å‰Šé™¤å¯¾è±¡ã‚’æ­£ç¢ºã«ç‰¹å®šå¯èƒ½

### ç›®çš„
- è£œå®Œã«ä½¿ã‚ã‚ŒãŸå‘¨è¾ºæ–‡ã®æ§‹æˆå…ƒã‚’æ˜ç¤ºçš„ã«è¨˜éŒ²ã—ã€å¾Œç¶šã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã¨é€£æºã™ã‚‹
- ãƒ•ã‚£ãƒ©ãƒ¼å‡¦ç†ã®ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã€å‰Šé™¤å¯¾è±¡ã®ç‰¹å®šã‚’æ­£ç¢ºã«è¡Œã†

## 2025å¹´1æœˆ27æ—¥ - QueueSummarizationFunc ãƒ­ã‚°å¼·åŒ–ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ”¹å–„

### ğŸ¯ å¤‰æ›´ç›®çš„
QueueSummarizationFunc ã®Poison Queueå•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€è©³ç´°ãªãƒ­ã‚°è¿½åŠ ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ä¿¡é ¼æ€§å‘ä¸Šã‚’å®Ÿæ–½ã€‚

### ğŸ“ å¤‰æ›´å†…å®¹

#### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `SpeechToTextPipeline/function_app.py`
- `SpeechToTextPipeline/openai_processing/openai_completion_step7.py`

#### 1. QueueSummarizationFunc ãƒ­ã‚°å¼·åŒ–

**è¿½åŠ ã•ã‚ŒãŸãƒ­ã‚°ãƒã‚¤ãƒ³ãƒˆï¼š**

**1. é–¢æ•°é–‹å§‹æ™‚ã® meeting_id ãƒ­ã‚°å‡ºåŠ›**
```python
logging.info(f"=== QueueSummarizationFunc é–‹å§‹: meeting_id={meeting_id} ===")
```

**2. ProcessedTranscriptSegments æŠ½å‡ºç›´å¾Œ**
```python
logging.info(f"[DEBUG] ProcessedTranscriptSegments è¡Œæ•°: {len(rows)}")
if not rows:
    logging.warning(f"[WARN] meeting_id={meeting_id} ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚")
```

**3. ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ã® OpenAI API å‘¼ã³å‡ºã—ç›´å‰**
```python
logging.info(f"[DEBUG] OpenAIã¸è¦ç´„ä¾é ¼: block_index={i}, ç™ºè©±æ•°={len(lines_only)}")
logging.info(f"[DEBUG] conversation_text ã‚µãƒ³ãƒ—ãƒ«: {conversation_text[:100]}...")
```

**4. OpenAI å¿œç­”å¾Œã®ãƒ­ã‚°**
```python
logging.info(f"[DEBUG] OpenAI å¿œç­” title: {title}")
```

**5. ConversationSummaries ã¸ã® summary æŒ¿å…¥å¾Œ**
```python
logging.info(f"[DB] SummaryæŒ¿å…¥å®Œäº†: meeting_id={meeting_id}, offset={block['start_offset']}")
```

**6. å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæŒ¿å…¥æ™‚**
```python
logging.info(f"[INSERT] Seg: speaker={speaker}, offset={offset}, content='{content[:30]}...'")
```

**7. æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‰ç¢ºèªï¼ˆqueue-exportã¸ï¼‰**
```python
account_name_match = re.search(r'AccountName=([^;]+)', conn_str)
if account_name_match:
    logging.info(f"[DEBUG] queue-exporté€ä¿¡å…ˆ: {account_name_match.group(1)}")
logging.info(f"[DEBUG] queue-export ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æº–å‚™å®Œäº†")
```

**8. ä¾‹å¤–ç™ºç”Ÿæ™‚ã®å®Œå…¨ãªã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹**
```python
logging.error(f"[EXCEPTION] queue_summarization_func failed for meeting_id={meeting_id}")
logging.exception(f"âŒ QueueSummarizationFunc ã‚¨ãƒ©ãƒ¼ (meeting_id={meeting_id if 'meeting_id' in locals() else 'unknown'}): {e}")
```

#### 2. extract_offset_from_line é–¢æ•°ã®ãƒ­ãƒã‚¹ãƒˆåŒ–

**ä¿®æ­£å‰ï¼š**
```python
match = re.match(r"(Speaker\d+: .+?)\(([\d.]+)\)$", line)
if match:
    body = match.group(1).rstrip()
    offset = float(match.group(2))
    return body, offset
else:
    return line, None
```

**ä¿®æ­£å¾Œï¼š**
```python
# æœ€å¾Œã®æ‹¬å¼§å†…ãŒæ•´æ•°ã¾ãŸã¯å°æ•°ã®å½¢å¼ "(12)" "(12.5)" ã«ä¸€è‡´
match = re.search(r"\((\d+(?:\.\d+)?)\)\s*$", line)
if not match:
    return line, None  # offsetãªã—è¡Œ

offset = float(match.group(1))
# æœ«å°¾ã® (æ•°å€¤) ã‚’é™¤å»ã—ã¦æœ¬æ–‡ã‚’å–å¾—
body = re.sub(r"\(\d+(?:\.\d+)?\)\s*$", "", line).strip()
return body, offset
```

#### 3. cleaned_text å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£

**ä¿®æ­£å‰ï¼š**
```python
speaker = int(line.split(":")[0].replace("Speaker", ""))
content = line.split(":")[1].split("(")[0].strip()
```

**ä¿®æ­£å¾Œï¼š**
```python
# segment_id ã‹ã‚‰å…ƒã® cleaned_text ã‚’å†å–å¾—
cursor.execute("""
    SELECT speaker, cleaned_text, offset_seconds 
    FROM dbo.ProcessedTranscriptSegments 
    WHERE id = ?
""", (seg_id,))
seg_row = cursor.fetchone()

if not seg_row:
    logging.warning(f"[WARN] ProcessedTranscriptSegments ã«id={seg_id}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    continue

speaker, cleaned_text, offset = seg_row
content = cleaned_text
```

#### 4. send_queue_message é–¢æ•°ã®Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¯¾å¿œ

**ä¿®æ­£å‰ï¼š**
```python
# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
message_json = json.dumps(message)
queue_client.send_message(message_json)
```

**ä¿®æ­£å¾Œï¼š**
```python
# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›ã—ã€æ˜ç¤ºçš„ã«Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
json_message = json.dumps(payload)
base64_encoded = base64.b64encode(json_message.encode("utf-8")).decode("utf-8")
queue_client.send_message(base64_encoded)
```

#### 5. QueueExportFunc å—ä¿¡ãƒ­ã‚°è¿½åŠ 

**è¿½åŠ ã•ã‚ŒãŸãƒ­ã‚°ï¼š**
```python
# å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ­ã‚°è¿½åŠ 
raw_message = message.get_body().decode('utf-8')
logging.info(f"[DEBUG] Raw message: {raw_message}")
```

### ğŸ—‚ å½±éŸ¿ç¯„å›²

#### å¯¾è±¡é–¢æ•°
- `QueueSummarizationFunc`
- `QueueExportFunc`
- `send_queue_message`
- `extract_offset_from_line`

#### å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«
- `ProcessedTranscriptSegments`
- `ConversationSummaries`

### âœ… æœŸå¾…åŠ¹æœ

#### 1. Poison Queueå•é¡Œã®è§£æ±º
- è©³ç´°ãªãƒ­ã‚°ã«ã‚ˆã‚Šã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€ã‚’ç‰¹å®š
- Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ä¿¡é ¼æ€§å‘ä¸Š
- `extract_offset_from_line`ã®ãƒ­ãƒã‚¹ãƒˆåŒ–ã«ã‚ˆã‚Šå‡¦ç†æ¼ã‚Œã‚’å‰Šæ¸›

#### 2. ãƒ‡ãƒ¼ã‚¿å“è³ªã®å‘ä¸Š
- `cleaned_text`ã®æ­£ç¢ºãªå¾©å…ƒ
- è¤‡é›‘ãªæ‹¬å¼§ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®æ­£ç¢ºãªoffsetæŠ½å‡º
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–

#### 3. ãƒ‡ãƒãƒƒã‚°èƒ½åŠ›ã®å‘ä¸Š
- å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®è©³ç´°ãƒ­ã‚°
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡ã®å¯è¦–åŒ–
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®å®Œå…¨ãªã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹

### ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- ãƒ­ã‚°å‡ºåŠ›ã®ç›£è¦–ã¨Poison Queueå•é¡Œã®è§£æ±ºç¢ºèª
- å¿…è¦ã«å¿œã˜ãŸè¿½åŠ ã®ãƒ­ã‚°å¼·åŒ–
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã¨æœ€é©åŒ–

## 2025å¹´1æœˆ27æ—¥ - Pollingåœæ­¢ã¨ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…

### ğŸ¯ å¤‰æ›´ç›®çš„
ä¸å®‰å®šãªãƒãƒ¼ãƒªãƒ³ã‚°å‡¦ç†ã‚’å»ƒæ­¢ã—ã€Speech-to-Textã‚¸ãƒ§ãƒ–å®Œäº†ã¨åŒæ™‚ã«æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã®å®‰å®šã—ãŸå‡¦ç†ãƒ•ãƒ­ãƒ¼ã«å¤‰æ›´ã€‚

### ğŸ“ å¤‰æ›´å†…å®¹

#### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `SpeechToTextPipeline/function_app.py`

#### 1. PollingTranscriptionResults ã®åœæ­¢

**ä¿®æ­£å‰ï¼š**
```python
@app.function_name(name="PollingTranscriptionResults")
@app.schedule(schedule="0 */5 * * * *", arg_name="timer", run_on_startup=False, use_monitor=False)
def polling_transcription_results(timer: func.TimerRequest) -> None:
```

**ä¿®æ­£å¾Œï¼š**
```python
# PollingTranscriptionResults ã‚’åœæ­¢ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã«å¤‰æ›´ï¼‰
# @app.function_name(name="PollingTranscriptionResults")
# @app.schedule(schedule="0 */5 * * * *", arg_name="timer", run_on_startup=False, use_monitor=False)
# def polling_transcription_results(timer: func.TimerRequest) -> None:
```

#### 2. TriggerTranscriptionJob ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡è¿½åŠ 

**è¿½åŠ ã•ã‚ŒãŸå‡¦ç†ï¼š**
```python
# Speech-to-Text ã‚¸ãƒ§ãƒ–ç™»éŒ²å®Œäº†å¾Œã€queue-preprocessing ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
try:
    send_queue_message("queue-preprocessing", {"meeting_id": meeting_id})
    logging.info(f"âœ… queue-preprocessing ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†: meeting_id={meeting_id}")
except Exception as queue_error:
    logging.error(f"âŒ queue-preprocessing ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¤±æ•—: {queue_error}")
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¤±æ•—ã§ã‚‚å‡¦ç†ã¯ç¶™ç¶šï¼ˆå¾Œã§æ‰‹å‹•ã§å†å®Ÿè¡Œå¯èƒ½ï¼‰
```

#### 3. send_queue_message é–¢æ•°ã®å®‰å…¨ä»•æ§˜å®Ÿè£…

**ä¿®æ­£å‰ï¼š**
```python
def send_queue_message(queue_name: str, payload: dict):
    try:
        import base64
        
        queue_service = get_queue_service_client()
        queue_client = queue_service.get_queue_client(queue_name)
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›ã—ã€æ˜ç¤ºçš„ã«Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        json_message = json.dumps(payload)
        base64_encoded = base64.b64encode(json_message.encode("utf-8")).decode("utf-8")
        queue_client.send_message(base64_encoded)
        
        logging.info(f"âœ… ã‚­ãƒ¥ãƒ¼ '{queue_name}' ã«é€ä¿¡æˆåŠŸ: {json_message}")
    except Exception as e:
        logging.exception(f"[ERROR] ã‚­ãƒ¥ãƒ¼ '{queue_name}' ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ")
        raise
```

**ä¿®æ­£å¾Œï¼š**
```python
def send_queue_message(queue_name: str, payload: dict):
    try:
        import base64
        from azure.storage.queue import QueueClient
        
        # æ¥ç¶šæ–‡å­—åˆ—ã‚’å–å¾—
        conn_str = os.environ.get("AzureWebJobsStorage")
        if not conn_str:
            raise ValueError("AzureWebJobsStorage ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        # ã‚­ãƒ¥ãƒ¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
        queue_client = QueueClient.from_connection_string(conn_str, queue_name)
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›ã—ã€æ˜ç¤ºçš„ã«Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        json_message = json.dumps(payload)
        base64_encoded = base64.b64encode(json_message.encode("utf-8")).decode("utf-8")
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        queue_client.send_message(base64_encoded)
        
        logging.info(f"âœ… ã‚­ãƒ¥ãƒ¼ '{queue_name}' ã«é€ä¿¡æˆåŠŸ: {json_message}")
    except Exception as e:
        logging.exception(f"[ERROR] ã‚­ãƒ¥ãƒ¼ '{queue_name}' ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ")
        raise
```

### ğŸ—‚ å½±éŸ¿ç¯„å›²

#### å¯¾è±¡é–¢æ•°
- `PollingTranscriptionResults`ï¼ˆåœæ­¢ï¼‰
- `TriggerTranscriptionJob`ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡è¿½åŠ ï¼‰
- `send_queue_message`ï¼ˆå®‰å…¨ä»•æ§˜å®Ÿè£…ï¼‰

#### å¯¾è±¡ã‚­ãƒ¥ãƒ¼
- `queue-preprocessing`

### âœ… æœŸå¾…åŠ¹æœ

#### 1. ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã®å®‰å®šã—ãŸå‡¦ç†ãƒ•ãƒ­ãƒ¼
- ä¸å®‰å®šãªãƒãƒ¼ãƒªãƒ³ã‚°å‡¦ç†ã‚’å»ƒæ­¢
- Speech-to-Textã‚¸ãƒ§ãƒ–å®Œäº†ã¨åŒæ™‚ã«æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹
- å…¨ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚­ãƒ¥ãƒ¼ã‚’é€šã˜ã¦ã¤ãªãŒã‚‹

#### 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ä¿¡é ¼æ€§å‘ä¸Š
- æ˜ç¤ºçš„ãªBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚ŠAzure Queue Storageã§ã®ç¢ºå®Ÿãªä¿å­˜
- æ¥ç¶šæ–‡å­—åˆ—ã®æ¤œè¨¼
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–

#### 3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¿½è·¡ã®æ”¹å–„
- å„ã‚¹ãƒ†ãƒƒãƒ—ã®é–‹å§‹ãƒ»å®Œäº†ãŒæ˜ç¢º
- éšœå®³åˆ‡ã‚Šåˆ†ã‘ãŒå®¹æ˜“
- æ‰‹å‹•ã§ã®å†å®Ÿè¡ŒãŒå¯èƒ½

### ğŸ”„ æ–°ã—ã„å‡¦ç†ãƒ•ãƒ­ãƒ¼

#### ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒ•ãƒ­ãƒ¼
1. **Blob Upload** â†’ EventGrid Trigger
2. **TriggerTranscriptionJob** â†’ Speech-to-Textç™»éŒ²
3. **Speech-to-Textå®Œäº†** â†’ Callback URL
4. **TriggerTranscriptionJob** â†’ `queue-preprocessing`é€ä¿¡
5. **QueuePreprocessingFunc** â†’ `queue-merging`é€ä¿¡
6. **QueueMergingAndCleanupFunc** â†’ `queue-summary`é€ä¿¡
7. **QueueSummarizationFunc** â†’ `queue-export`é€ä¿¡
8. **QueueExportFunc** â†’ å®Œäº†

#### ãƒ­ã‚°å‡ºåŠ›ä¾‹
```
=== Transcription Job Trigger Start ===
Blob URL: https://storage.blob.core.windows.net/container/meeting_102_user_1_audio.wav
ğŸ¯ Extracted meeting_id=102, user_id=1
âœ… SAS URL ç”ŸæˆæˆåŠŸ: https://...
ğŸ“ file_size=1234567 bytes, duration_seconds=300 sec
ğŸ†” Transcription Job ID: abc123
âœ… Meetings ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰æŒ¿å…¥å®Œäº†
âœ… queue-preprocessing ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†: meeting_id=102
```

### ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒ•ãƒ­ãƒ¼ã®å‹•ä½œç¢ºèª
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ä¿¡é ¼æ€§ç›£è¦–
- å¿…è¦ã«å¿œã˜ãŸè¿½åŠ ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

## 2025å¹´1æœˆ27æ—¥ - SASãƒˆãƒ¼ã‚¯ãƒ³å–å¾—APIçµ±ä¸€åŒ–

### ğŸ¯ å¤‰æ›´ç›®çš„
éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½å…¨èˆ¬ã§SASãƒˆãƒ¼ã‚¯ãƒ³å–å¾—APIã®å‘¼ã³å‡ºã—æ–¹å¼ã‚’POST + JSONãƒœãƒ‡ã‚£å½¢å¼ã«çµ±ä¸€ã—ã€APIä½¿ç”¨æ–¹æ³•ã®ä¸€è²«æ€§ã¨å®‰å®šæ€§ã‚’ç¢ºä¿ã€‚

### ğŸ“ å¤‰æ›´å†…å®¹

#### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `next-app/src/hooks/useRecording.ts`
- `next-app/src/app/api/azure/get-sas-token/route.ts`

#### 1. useRecording.tsã®ä¿®æ­£

**ä¿®æ­£å‰**:
```typescript
const sasResponse = await fetch(`/api/azure/get-sas-token?fileName=${encodeURIComponent(fileName)}`)
```

**ä¿®æ­£å¾Œ**:
```typescript
const sasResponse = await fetch('/api/azure/get-sas-token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({ fileName })
})
```

#### 2. get-sas-token APIã®ä¿®æ­£

**è¿½åŠ å†…å®¹**:
- POSTãƒ¡ã‚½ãƒƒãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‹ã‚‰`fileName`ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…
- CORSãƒ˜ãƒƒãƒ€ãƒ¼ã«POSTãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 

**è¿½åŠ ã•ã‚ŒãŸPOSTãƒãƒ³ãƒ‰ãƒ©ãƒ¼**:
```typescript
export async function POST(request: NextRequest) {
  try {
    console.log('SASãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆé–‹å§‹ (POST)')
    
    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
    const body = await request.json()
    const fileName = body.fileName
    
    if (!fileName) {
      console.error('ãƒ•ã‚¡ã‚¤ãƒ«åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“')
      return NextResponse.json(
        { error: 'ãƒ•ã‚¡ã‚¤ãƒ«åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 400 }
      )
    }
    
    // ... æ—¢å­˜ã®SASãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
  } catch (error) {
    // ... ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  }
}
```

### ğŸ—‚ å½±éŸ¿ç¯„å›²
- éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½å…¨èˆ¬
- éŒ²éŸ³ç”»é¢ã¨å•†è«‡ä½œæˆç”»é¢ã®ä¸¡æ–¹ã§åŒã˜APIå‘¼ã³å‡ºã—æ–¹å¼ã‚’ä½¿ç”¨

### âœ… æœŸå¾…åŠ¹æœ
1. **ä¸€è²«æ€§ã®ç¢ºä¿**: éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®å…¨ãƒšãƒ¼ã‚¸ã§åŒã˜APIå‘¼ã³å‡ºã—æ–¹å¼ã‚’ä½¿ç”¨
2. **ãƒã‚°ã®é˜²æ­¢**: GET/POSTæ··åœ¨ã«ã‚ˆã‚‹å°†æ¥çš„ãªãƒã‚°ã‚’é˜²æ­¢
3. **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§å‘ä¸Š**: çµ±ä¸€ã•ã‚ŒãŸAPIä½¿ç”¨æ–¹æ³•ã«ã‚ˆã‚Šä¿å®ˆæ€§ãŒå‘ä¸Š
4. **ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ**: "ãƒ•ã‚¡ã‚¤ãƒ«åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"ã‚¨ãƒ©ãƒ¼ã®è§£æ¶ˆ

### ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- çµ±ä¸€åŒ–å¾Œã®APIå‹•ä½œç¢ºèª
- å…¨ãƒšãƒ¼ã‚¸ã§ã®éŸ³å£°ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
- å¿…è¦ã«å¿œã˜ãŸè¿½åŠ ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

## 2025å¹´1æœˆ27æ—¥ - TriggerTranscriptionJob æ–‡å­—èµ·ã“ã—ãƒ­ã‚¸ãƒƒã‚¯çµ±åˆã¨Queueãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ”¹å–„

### ğŸ¯ å¤‰æ›´ç›®çš„
`PollingTranscriptionResults`ã®å»ƒæ­¢ã«ä¼´ã„ã€éåŒæœŸSTTã‚¸ãƒ§ãƒ–ã®å®Œäº†ç¢ºèªãƒ»æ–‡å­—èµ·ã“ã—çµæœã®ä¿å­˜å‡¦ç†ãŒæ¶ˆå¤±ã—ã¦ã„ãŸå•é¡Œã‚’è§£æ±ºã€‚`TriggerTranscriptionJob`ã«æ–‡å­—èµ·ã“ã—ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±åˆã—ã€Queueãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®æ”¹å–„ã‚’å®Ÿæ–½ã€‚

### ğŸ“ å¤‰æ›´å†…å®¹

#### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `SpeechToTextPipeline/function_app.py`

#### 1. TriggerTranscriptionJob æ–‡å­—èµ·ã“ã—ãƒ­ã‚¸ãƒƒã‚¯çµ±åˆ

**è¿½åŠ ã•ã‚ŒãŸæ©Ÿèƒ½**:
- **ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—**: æœ€å¤§20å›ã€15ç§’é–“éš”ã§ã‚¸ãƒ§ãƒ–å®Œäº†ã‚’ç¢ºèª
- **æ–‡å­—èµ·ã“ã—çµæœå–å¾—**: `contenturl_0.json`ã‹ã‚‰`recognizedPhrases`ã‚’å–å¾—
- **transcript_textåˆæˆ**: è©±è€…ã€ãƒ†ã‚­ã‚¹ãƒˆã€ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’å«ã‚€å½¢å¼ã§åˆæˆ
- **DBæ›´æ–°**: `Meetings`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`transcript_text`ã¨`status`ã‚’æ›´æ–°

**å®Ÿè£…ã‚³ãƒ¼ãƒ‰**:
```python
# ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
max_retries = 20
sleep_seconds = 15
transcription_url = f"https://{region}.api.cognitive.microsoft.com/speechtotext/v3.0/transcriptions/{job_id}"

for i in range(max_retries):
    status_resp = requests.get(transcription_url, headers=headers)
    job_status = status_resp.json().get("status")
    
    if job_status == "Succeeded":
        break
    elif job_status in ["Failed", "Canceled"]:
        # ã‚¨ãƒ©ãƒ¼å‡¦ç†
        return func.HttpResponse(f"Transcription failed: {job_status}", status_code=500)
    
    time.sleep(sleep_seconds)
else:
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
    return func.HttpResponse("Timeout waiting for transcription result", status_code=504)

# æ–‡å­—èµ·ã“ã—çµæœå–å¾—ã¨DBæ›´æ–°
if job_status == "Succeeded":
    # transcriptionãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
    files_url = f"{transcription_url}/files"
    files_resp = requests.get(files_url, headers=headers)
    files_data = files_resp.json()

    transcription_files = [
        f for f in files_data["values"]
        if f.get("kind") == "Transcription" and f.get("name", "").startswith("contenturl_0")
    ]
    
    # transcript_textåˆæˆ
    transcript = []
    for phrase in result_json["recognizedPhrases"]:
        speaker = phrase.get("speaker", "Unknown")
        text = phrase["nBest"][0]["display"]
        offset = phrase.get("offset", "PT0S")
        try:
            offset_seconds = round(isodate.parse_duration(offset).total_seconds(), 1)
        except:
            offset_seconds = 0.0
        transcript.append(f"(Speaker{speaker})[{text}]({offset_seconds})")
    transcript_text = " ".join(transcript)

    # DBæ›´æ–°
    cursor.execute("""
        UPDATE dbo.Meetings
        SET transcript_text = ?, status = 'transcribed',
            updated_datetime = GETDATE(), end_datetime = GETDATE()
        WHERE meeting_id = ? AND user_id = ?
    """, (transcript_text, meeting_id, user_id))
    conn.commit()
```

#### 2. send_queue_message é–¢æ•°ã®ãƒ­ã‚°å¼·åŒ–

**è¿½åŠ ã•ã‚ŒãŸãƒ­ã‚°**:
```python
# ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼šé€ä¿¡å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æƒ…å ±
logging.info(f"ğŸ“¤ ã‚­ãƒ¥ãƒ¼é€ä¿¡æº–å‚™: queue_name='{queue_name}', payload_type={type(payload)}, payload={payload}")

# ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼šå¤‰æ›å¾Œã®æƒ…å ±
logging.info(f"ğŸ“¤ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›: json_message='{json_message}', base64_length={len(base64_encoded)}")
```

#### 3. TriggerTranscriptionJob ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ”¹å–„

**ä¿®æ­£å‰**:
```python
send_queue_message("queue-preprocessing", {"meeting_id": meeting_id})
```

**ä¿®æ­£å¾Œ**:
```python
message = {"meeting_id": meeting_id, "user_id": user_id}
send_queue_message("queue-preprocessing", message)
```

### ğŸ—‚ å½±éŸ¿ç¯„å›²

#### å¯¾è±¡é–¢æ•°
- `TriggerTranscriptionJob`
- `send_queue_message`

#### å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«
- `Meetings`ï¼ˆtranscript_textã€statusæ›´æ–°ï¼‰

### âœ… æœŸå¾…åŠ¹æœ

#### 1. æ–‡å­—èµ·ã“ã—å‡¦ç†ã®çµ±åˆ
- éåŒæœŸSTTã‚¸ãƒ§ãƒ–ã®å®Œäº†ç¢ºèªã‚’`TriggerTranscriptionJob`å˜ç‹¬ã§å®Œçµ
- `transcript_text`ã‚’ç”Ÿæˆãƒ»ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€å¾Œç¶šå‡¦ç†ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’ä¾›çµ¦
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„ï¼ˆå¤±æ•—ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®é©åˆ‡ãªçŠ¶æ…‹ç®¡ç†ï¼‰

#### 2. Queueãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®æ”¹å–„
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡éç¨‹ã®è©³ç´°ãªå¯è¦–åŒ–
- `user_id`ã‚’å«ã‚€å®Œå…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å……å®Ÿã«ã‚ˆã‚‹å•é¡Œç‰¹å®šã®å®¹æ˜“åŒ–

#### 3. å‡¦ç†ã®å®‰å…¨æ€§å‘ä¸Š
- é©åˆ‡ãªHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®ä½¿ç”¨
- ãƒãƒ¼ãƒªãƒ³ã‚°ã®ç¢ºå®Ÿãªåœæ­¢
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®æ˜ç¢ºåŒ–ï¼ˆ200/500/504ï¼‰

### ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
- çµ±åˆå¾Œã®æ–‡å­—èµ·ã“ã—å‡¦ç†ã®å‹•ä½œç¢ºèª
- Queueãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ä¿¡é ¼æ€§ç›£è¦–
- å¿…è¦ã«å¿œã˜ãŸè¿½åŠ ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ– 