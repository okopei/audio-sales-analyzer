# 変更履歴 - 新規ユーザー登録機能

## 2025-01-27（バックエンド）
- `/register` エンドポイントを Azure Functions v2 構成（function_app.py）に追加
- CORS対応は `build_cors_headers("POST, OPTIONS")` を使用
- パスワードハッシュ化には `bcrypt + salt` を導入
- 重複メールアドレスのチェック実装済み
- 成功時に `user_id` を返却する構成

### 実装詳細
- **エンドポイント**: `POST /register`
- **関数名**: `register_user`
- **認証レベル**: `func.AuthLevel.ANONYMOUS`
- **入力パラメータ**: `email`, `user_name`, `password`
- **レスポンス形式**: JSON形式で `success`, `message`, `user_id` を返却

### エラーハンドリング
- **400 Bad Request**: 必須パラメータ不足
- **409 Conflict**: メールアドレス重複
- **500 Internal Server Error**: サーバーエラー

### セキュリティ対策
- パスワードは `bcrypt` でハッシュ化
- ソルトは自動生成
- データベースにはハッシュ化されたパスワードのみ保存

## 2025-01-27（フロントエンド）
- `/register` 画面のUIを実装（フォーム、バリデーション、API接続、画面遷移）
- 入力項目：user_name, email, password
- ローカル環境では `http://localhost:7071/api/register` を使用
- 本番環境では `https://saa-api-func.azurewebsites.net/api/register` を使用
- 登録成功後に `/login` に遷移、失敗時はエラーメッセージを表示
- `function_app.py` 内の Login 関数構成を参考に、通信処理と例外処理を統一

### 実装機能
- **入力バリデーション**: 必須項目チェック、メール形式チェック、パスワード文字数チェック
- **API接続**: 環境変数 `NEXT_PUBLIC_API_BASE_URL` を使用した動的エンドポイント設定
- **エラーハンドリング**: APIエラーレスポンスの適切な表示
- **ローディング状態**: 登録処理中のボタン無効化とスピナー表示
- **成功時遷移**: 登録成功後、ログインページに `?registered=true` パラメータ付きで遷移

### UI/UX設計
- **デザイン**: ログイン画面と統一したダークテーマ
- **フォーム**: 3つの入力フィールド（名前、メール、パスワード）
- **エラー表示**: 赤色のエラーメッセージボックス
- **ローディング**: スピナー付きの「登録中...」ボタン
- **ナビゲーション**: ログインページへのリンク

## 2025-01-27（仕様追加）
- 新規ユーザー登録時に「マネージャー区分（is_manager）」を指定可能にした
- フロント：チェックボックスUIを追加、APIにis_manager: booleanを送信
- バックエンド：リクエストBodyからis_managerを受け取り、Usersテーブルに反映

### 実装詳細
- **フロントエンド**: チェックボックスUIを追加、デフォルトはfalse
- **バックエンド**: is_managerパラメータを受け取り、BIT型としてデータベースに保存
- **データベース**: Users.is_managerカラムにTrue/Falseを保存

## 2025-01-27（メール認証機能追加）
- 新規ユーザー登録時にメール認証機能を追加
- 登録時は `is_active=False` で仮登録し、認証トークンを生成
- SMTP（Gmail）を使用して認証メールを送信
- ログイン時は `is_active=True` のユーザーのみログイン可能に変更

### 実装詳細
- **認証トークン**: UUID4を使用して推測困難なトークンを生成
- **メール送信**: Gmail SMTPを使用して認証リンク付きメールを送信
- **セキュリティ**: メール送信エラーはログのみに記録（攻撃防止）
- **データベース**: `activation_token` カラムを追加してトークンを保存
- **ログイン制御**: 未認証ユーザー（`is_active=False`）はログイン不可

## 2025-01-27（メール認証機能 - アクティベート処理）
- 認証メール内のリンクに対応する `GET /api/activate?token=...` エンドポイントを新規追加
- 有効なトークンが指定された場合、Users テーブルの `is_active` を True に更新し、`activation_token` を削除
- 不正なトークンや使用済みトークンは404で応答
- レスポンス形式は JSON（将来的にHTML化も可能）

### 実装詳細
- **エンドポイント**: `GET /api/activate?token=xxx`
- **トークン検証**: `activation_token` でユーザーを検索
- **有効化処理**: `is_active=1`, `activation_token=NULL` に更新
- **セキュリティ**: トークンは一度使用後は無効化
- **エラーハンドリング**: 適切なHTTPステータスコードとメッセージ

## 2025-01-27（メッセージ修正・ログ強化）
- ログイン画面の登録完了メッセージを認証メール確認案内に変更
- バックエンドのメール送信ログを詳細化（デバッグ用）

### 修正内容
- **フロントエンド**: 登録完了メッセージを「認証用メールをご確認ください」に変更
- **バックエンド**: `send_email_smtp()` 関数に詳細ログを追加
  - 宛先ログの強化
  - メール本文ログ（デバッグ用）
  - SMTP応答のログ出力
  - 送信エラーの詳細ログ

### デバッグ支援
- メール送信状況の詳細確認が可能
- 本番環境ではメール本文ログをコメントアウト推奨
- Gmail送信済みフォルダ、Azure Functionログ、環境変数設定の確認方法を提供

## 2025-01-27（SMTP送信トレースログ強化）
- `send_email_smtp()` 関数に詳細なトレースログを追加
- 各処理段階でのログ出力により、メール送信の流れを可視化

### 追加ログ内容
- **開始時ログ**: `📧 send_email_smtp() 呼び出し開始 → 宛先: {to_email}`
- **サーバ接続ログ**: `🔄 SMTPサーバ接続開始（smtp.gmail.com:587）`
- **ログイン成功ログ**: `🔐 SMTPログイン成功: {from_email}`
- **送信完了ログ**: `📤 メール送信処理完了 → response: {response}`
- **エラー詳細ログ**: `🚨 SMTP送信エラー: {str(e)}`

### 確認方法
Azure Portal > 対象の Function App > ログストリーム（Log Stream）で以下を確認：
- 関数が呼ばれたか: `📧 send_email_smtp() 呼び出し開始`
- SMTP接続成功: `🔄 SMTPサーバ接続開始` → `🔐 SMTPログイン成功`
- メール送信結果: `📤 メール送信処理完了 → response: None`（通常は None）
- エラーがあるか: `🚨 SMTP送信エラー: ...` の有無

## 2025-01-27（認証完了画面のHTML化）
- `/api/activate` エンドポイントの成功時にHTMLページを返すように変更
- ユーザーにわかりやすい認証完了画面を提供

### 実装内容
- **成功時**: HTMLページを直接返却（JSONから変更）
- **失敗時**: 従来通りJSONレスポンス
- **デザイン**: 中央配置、シンプルなスタイル、スマホ対応
- **ナビゲーション**: ログイン画面へのボタンリンク

### HTMLページの特徴
- 認証完了メッセージとボタンを表示
- 自動リダイレクトではなく、ユーザーの操作でログインページへ進む設計
- 本番URL（https://audio-sales-analyzer.vercel.app/）に直接リンク
- レスポンシブデザインでスマホでも見やすい

## 2025-01-27（認証完了画面のレスポンシブ対応強化）
- `/api/activate` 成功時のHTMLをレスポンシブ対応に強化
- PC/スマホ両対応のモダンなデザインに変更

### 修正内容
- **viewport追加**: スマホでのズーム/幅調整が正しく動作
- **max-width: 90%**: モバイルでは画面幅に応じて自動調整
- **rem単位**: スマホでも見やすい文字サイズに調整
- **box-shadow & padding**: スマホでもカード風に表示（視認性UP）
- **flexboxレイアウト**: 中央配置で美しい表示
- **ホバーエフェクト**: ボタンにホバー時の色変化を追加

### デザイン改善点
- モダンなフォントスタック（-apple-system, BlinkMacSystemFont等）
- グレー背景に白いカードのコントラスト
- 適切な余白とボーダーラジウス
- スムーズなトランジション効果 